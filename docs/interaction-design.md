# ChaosSaga - 交互流程与执行逻辑

> 玩家与系统的交互实践案例

---

## 一、核心交互流程概览

```
┌─────────────────────────────────────────────────────────────┐
│                    玩家游戏主循环                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌──────────┐                                              │
│   │  登录    │                                              │
│   └────┬─────┘                                              │
│        ▼                                                    │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐             │
│   │  主界面  │ ←→ │  背包    │ ←→ │  技能    │             │
│   └────┬─────┘    └──────────┘    └──────────┘             │
│        │                                                    │
│        ▼                                                    │
│   ┌──────────┐    ┌──────────┐                             │
│   │ 选择区域 │ →  │ AI生成   │ ← 首次进入时触发            │
│   └────┬─────┘    │ 区域背景 │                             │
│        │          └──────────┘                             │
│        ▼                                                    │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐             │
│   │ 开始冒险 │ →  │ AI生成   │ →  │ 进入战斗 │             │
│   └──────────┘    │ 关卡     │    └────┬─────┘             │
│                   └──────────┘         │                   │
│        ┌───────────────────────────────┘                   │
│        ▼                                                    │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐             │
│   │ 回合战斗 │ →  │ AI叙事   │ →  │ 结算奖励 │             │
│   └──────────┘    └──────────┘    └────┬─────┘             │
│                                        │                   │
│        ┌───────────────────────────────┘                   │
│        ▼                                                    │
│   ┌──────────┐                                              │
│   │ 返回主页 │ → (循环)                                     │
│   └──────────┘                                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 二、场景1：新玩家创建角色

### 2.1 用户操作流程

```
用户                          前端界面                      后端系统
 │                              │                              │
 │───── 点击"创建角色" ────────→│                              │
 │                              │                              │
 │←──── 显示创建表单 ───────────│                              │
 │                              │                              │
 │───── 输入名字"小海" ─────────→│                              │
 │───── 选择背景"海洋之子" ────→│                              │
 │───── 点击"开始冒险" ─────────→│                              │
 │                              │                              │
 │                              │──── POST /api/player ────────→│
 │                              │     {name, background}       │
 │                              │                              │
 │                              │                    ┌─────────┴─────────┐
 │                              │                    │ 1. 验证输入        │
 │                              │                    │ 2. 计算初始属性    │
 │                              │                    │ 3. 创建玩家记录    │
 │                              │                    │ 4. 初始化技能      │
 │                              │                    │ 5. 发放新手装备    │
 │                              │                    └─────────┬─────────┘
 │                              │                              │
 │                              │←─── 返回玩家数据 ────────────│
 │                              │                              │
 │←──── 跳转到主界面 ───────────│                              │
 │      显示角色信息            │                              │
```

### 2.2 后端执行逻辑

```
POST /api/player

1. 输入验证
   ├── 检查名称是否为空
   ├── 检查名称是否重复
   └── 验证背景选项有效性

2. 初始属性计算
   ├── 基础HP = 100 + 1×20 = 120
   ├── 基础MP = 80 + 1×15 = 95
   ├── 攻击力 = 10 + 1×5 = 15
   ├── 防御力 = 5 + 1×3 = 8
   └── 速度 = 50 + 1×2 = 52

3. 背景加成（海洋之子）
   ├── MP +20%  → 95 × 1.2 = 114
   ├── 初始技能: "潮汐之力"
   └── 奇遇概率 +15%

4. 数据库写入
   ├── 创建 Player 记录
   ├── 创建 PlayerSkill 记录 (潮汐之力)
   └── 创建 Inventory 记录 (新手装备)

5. 返回完整玩家状态
```

---

## 三、场景2：进入新区域

### 3.1 用户操作流程

```
用户                          前端界面                      后端系统                    Claude API
 │                              │                              │                              │
 │───── 点击"珊瑚海湾" ─────────→│                              │                              │
 │                              │                              │                              │
 │                              │── POST /api/areas/coral/enter→│                              │
 │                              │                              │                              │
 │                              │                    ┌─────────┴─────────┐                    │
 │                              │                    │ 检查是否首次进入   │                    │
 │                              │                    └─────────┬─────────┘                    │
 │                              │                              │                              │
 │                              │                              │────── 生成区域背景 ─────────→│
 │                              │                              │       (玩家境界、区域信息)   │
 │                              │                              │                              │
 │                              │                              │←───── 返回背景故事 ─────────│
 │                              │                              │       核心矛盾、NPC等        │
 │                              │                              │                              │
 │                              │                    ┌─────────┴─────────┐                    │
 │                              │                    │ 保存区域文档       │                    │
 │                              │                    │ 更新玩家位置       │                    │
 │                              │                    └─────────┬─────────┘                    │
 │                              │                              │                              │
 │                              │←─── 返回区域信息 ────────────│                              │
 │                              │                              │                              │
 │←──── 显示区域界面 ───────────│                              │                              │
 │      展示背景故事            │                              │                              │
 │      显示NPC列表             │                              │                              │
 │      显示可用副本            │                              │                              │
```

### 3.2 AI Prompt 设计

```
【系统角色】
你是ChaosSaga的剧本作家，负责为玩家生成沉浸式的区域背景故事。

【输入信息】
区域: 珊瑚海湾
区域类型: 海域
玩家境界: 海洋级 (Lv.5)
玩家背景: 海洋之子

【输出要求】
请生成以下内容（JSON格式）:
1. coreConflict: 这个区域正在发生什么主要冲突？(100字内)
2. playerGoal: 玩家来到这里的任务目标
3. keyNpcs: 2-3个关键NPC，包含名字、身份、立场
4. factions: 势力分布
5. hiddenSecrets: 可探索的隐藏内容提示

【风格要求】
- 保持奇幻海洋冒险风格
- 适合玩家当前境界的难度
- 留有探索悬念
```

### 3.3 存储的区域文档示例

```json
{
  "areaId": "coral_bay",
  "generatedAt": "2026-02-07T23:00:00Z",
  "content": {
    "coreConflict": "渔民与海妖族因珍珠矿脉归属问题产生争端，双方剑拔弩张...",
    "playerGoal": "调查近期失踪的三艘渔船，寻找真相",
    "keyNpcs": [
      { "name": "老渔夫阿海", "role": "任务NPC", "stance": "中立偏向渔民" },
      { "name": "海妖公主珊珊", "role": "剧情NPC", "stance": "可敌可友" },
      { "name": "神秘商人", "role": "商店NPC", "stance": "中立" }
    ],
    "factions": {
      "渔民联盟": "占据海岸，依赖渔业为生",
      "海妖一族": "守护珊瑚礁，拥有古老魔法"
    },
    "hiddenSecrets": ["沉船中的古老海图", "珊瑚深处的神秘洞穴"]
  }
}
```

---

## 四、场景3：开始随机冒险

### 4.1 用户操作流程

```
用户                  前端                  后端                  Claude API
 │                     │                     │                       │
 │── 点击"随机冒险" ──→│                     │                       │
 │                     │                     │                       │
 │                     │─ POST /api/battle/start ─→│                  │
 │                     │  {type:"random", areaId}  │                  │
 │                     │                     │                       │
 │                     │                     │─── 生成关卡请求 ──────→│
 │                     │                     │    (玩家状态、环境)    │
 │                     │                     │                       │
 │                     │                     │←── 关卡配置 ──────────│
 │                     │                     │    敌人、场景描述     │
 │                     │                     │                       │
 │                     │                     │   ┌────────────────┐  │
 │                     │                     │   │ 初始化战斗状态  │  │
 │                     │                     │   │ 创建Battle实例  │  │
 │                     │                     │   └────────────────┘  │
 │                     │                     │                       │
 │                     │←── 返回战斗初始化 ──│                       │
 │                     │                     │                       │
 │←─ 显示战斗界面 ─────│                     │                       │
 │   场景描述          │                     │                       │
 │   敌人状态          │                     │                       │
 │   行动选项          │                     │                       │
```

### 4.2 AI 关卡生成 Prompt

```
【系统角色】
你是ChaosSaga的关卡设计师，根据玩家状态生成合适难度的战斗关卡。

【玩家状态】
- 境界: 海洋级 Lv.5
- HP: 180/180, MP: 140/140
- 攻击: 25, 防御: 12
- 位置: 珊瑚海湾
- 天气: 雨天
- 时间: 傍晚
- 季节: 夏季

【输出要求】(JSON格式)
{
  "stageName": "关卡名称",
  "description": "场景描述(50字)",
  "enemies": [
    {
      "id": "enemy_1",
      "name": "敌人名称",
      "level": 5,
      "hp": 150,
      "attack": 20,
      "defense": 8,
      "skills": ["skill_id"],
      "element": "water"
    }
  ],
  "environmentEffect": "环境特效(如:雨天水系技能+10%)",
  "possibleLoot": ["item_id_1", "item_id_2"]
}

【约束】
- 敌人等级在玩家等级±2范围内
- 敌人数量1-3个
- 总战力不超过玩家的150%
```

---

## 五、场景4：回合制战斗执行

### 5.1 战斗回合流程

```
┌─────────────────────────────────────────────────────────────┐
│                      一个完整回合                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐                                            │
│  │ 回合开始    │                                            │
│  │ 计算行动顺序│ ← 按速度排序                               │
│  └──────┬──────┘                                            │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   玩家行动阶段                        │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  前端显示选项 → 玩家选择 → 发送到后端 → 执行计算    │   │
│  │        ↓              ↓           ↓           ↓      │   │
│  │  [攻击][技能]     点击冰箭术   action请求    伤害判定  │   │
│  │  [道具][防御]                               状态应用  │   │
│  │                                                       │   │
│  │  后端完成计算后 → 调用AI生成叙事 → 返回结果给前端    │   │
│  └──────────────────────────────────────────────────────┘   │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   敌人行动阶段                        │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  AI决策敌人行动 → 执行计算 → 生成叙事 → 返回结果     │   │
│  │       │              │           │           │       │   │
│  │  根据血量/状态   伤害/状态    描述动作    更新UI     │   │
│  │  选择技能或普攻  应用到玩家   渲染效果               │   │
│  └──────────────────────────────────────────────────────┘   │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────┐                                            │
│  │ 回合结束    │                                            │
│  │ 结算持续效果│ ← 中毒、灼烧、再生等                       │
│  │ 检查胜负    │                                            │
│  └──────┬──────┘                                            │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────┐      ┌─────────────┐                      │
│  │ 未结束?     │─否──→│ 结算奖励    │                      │
│  └──────┬──────┘      └─────────────┘                      │
│         │是                                                 │
│         ▼                                                   │
│    (进入下一回合)                                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 战斗行动 API 交互

```
用户                  前端                  后端                  Claude API
 │                     │                     │                       │
 │── 选择"冰箭术" ────→│                     │                       │
 │── 选择目标敌人 ────→│                     │                       │
 │                     │                     │                       │
 │                     │─ POST /api/battle/action ─→│                │
 │                     │  {                         │                │
 │                     │    battleId: "xxx",        │                │
 │                     │    action: "skill",        │                │
 │                     │    skillId: "ice_arrow",   │                │
 │                     │    targetId: "enemy_1"     │                │
 │                     │  }                         │                │
 │                     │                     │                       │
 │                     │                     │   ┌────────────────┐  │
 │                     │                     │   │ 伤害计算        │  │
 │                     │                     │   │ 基础 = 25×1.3  │  │
 │                     │                     │   │ = 32.5         │  │
 │                     │                     │   │ 克制加成 +30%  │  │
 │                     │                     │   │ = 42           │  │
 │                     │                     │   │ 应用减速效果   │  │
 │                     │                     │   └────────────────┘  │
 │                     │                     │                       │
 │                     │                     │─── 生成战斗叙事 ─────→│
 │                     │                     │   {action, damage,    │
 │                     │                     │    effect, context}   │
 │                     │                     │                       │
 │                     │                     │←── 叙事文本 ──────────│
 │                     │                     │                       │
 │                     │                     │   ┌────────────────┐  │
 │                     │                     │   │ 敌人AI决策     │  │
 │                     │                     │   │ (本地逻辑)     │  │
 │                     │                     │   └────────────────┘  │
 │                     │                     │                       │
 │                     │                     │─── 生成敌人叙事 ─────→│
 │                     │                     │                       │
 │                     │                     │←── 叙事文本 ──────────│
 │                     │                     │                       │
 │                     │←── 返回回合结果 ───│                       │
 │                     │  {                  │                       │
 │                     │    playerAction: {  │                       │
 │                     │      damage: 42,    │                       │
 │                     │      narrative: "..."│                      │
 │                     │    },               │                       │
 │                     │    enemyAction: {   │                       │
 │                     │      damage: 18,    │                       │
 │                     │      narrative: "..."│                      │
 │                     │    },               │                       │
 │                     │    battleStatus: {  │                       │
 │                     │      isFinished: false│                     │
 │                     │    }                │                       │
 │                     │  }                  │                       │
 │                     │                     │                       │
 │←─ 播放战斗动画 ─────│                     │                       │
 │   显示伤害数字      │                     │                       │
 │   显示叙事文本      │                     │                       │
 │   更新HP/MP条       │                     │                       │
```

### 5.3 伤害计算执行逻辑

```typescript
// lib/game/battle.ts

function calculateDamage(attacker, defender, skill) {
  // 1. 基础伤害
  let damage = attacker.attack * skill.damageRatio;

  // 2. 防御减伤
  const defenseReduction = defender.defense / (defender.defense + 100);
  damage = damage * (1 - defenseReduction);

  // 3. 暴击判定
  if (Math.random() < attacker.critRate) {
    damage = damage * attacker.critDamage;
  }

  // 4. 属性克制
  const elementBonus = getElementBonus(skill.element, defender.element);
  damage = damage * elementBonus; // 1.3 克制, 0.7 被克, 1.0 无关

  // 5. 环境加成
  const envBonus = getEnvironmentBonus(skill.element, battleContext);
  damage = damage * envBonus;

  // 6. 随机浮动 ±10%
  damage = damage * (0.9 + Math.random() * 0.2);

  return Math.floor(damage);
}
```

### 5.4 AI 战斗叙事 Prompt

```
【系统角色】
你是ChaosSaga的战斗解说员，用生动的文字描述战斗场面。

【当前战斗上下文】
- 玩家: 小海 (海洋级 Lv.5)
- 敌人: 深海蟹怪 (HP: 108/150)
- 场景: 珊瑚海湾礁石区，雨天傍晚
- 玩家武器: 骑鹅圈

【本回合行动】
- 玩家使用: 冰箭术
- 目标: 深海蟹怪
- 造成伤害: 42
- 附加效果: 减速2回合

【输出要求】
生成一段50字左右的战斗描述，要求:
1. 描述技能释放的视觉效果
2. 体现伤害造成的反馈
3. 自然地带出效果触发
4. 保持紧张刺激的战斗氛围

【示例输出】
"你挥动骑鹅圈，一道冰蓝色的箭矢破空而出！冰箭术精准命中蟹怪的关节，造成42点伤害！寒霜蔓延，蟹怪的动作明显迟缓了..."
```

---

## 六、场景5：战斗结算

### 6.1 结算流程

```
                    战斗胜利
                       │
                       ▼
              ┌────────────────┐
              │ 计算基础奖励   │
              │ - 经验值       │
              │ - 金币         │
              └───────┬────────┘
                      │
                      ▼
              ┌────────────────┐
              │ 掉落判定       │
              │ - 概率计算     │
              │ - 品质判定     │
              └───────┬────────┘
                      │
                      ▼
              ┌────────────────┐
              │ 图鉴更新       │
              │ - 新敌人?      │
              │ - 新道具?      │
              └───────┬────────┘
                      │
                      ▼
              ┌────────────────┐
              │ 升级检查       │
              │ - 经验是否足够? │
              │ - 触发升级流程 │
              └───────┬────────┘
                      │
                      ▼
              ┌────────────────┐
              │ 境界检查       │
              │ - 是否满足突破? │
              │ - 提示玩家     │
              └───────┬────────┘
                      │
                      ▼
              ┌────────────────┐
              │ 保存战斗日志   │
              │ - BattleLog    │
              │ - 用于历史查看 │
              └───────┬────────┘
                      │
                      ▼
                  返回结果
```

### 6.2 结算 API 响应

```json
{
  "result": "victory",
  "rewards": {
    "exp": 120,
    "gold": 85,
    "items": [
      { "id": "crab_shell", "name": "蟹壳碎片", "quantity": 2 },
      { "id": "water_essence", "name": "水之精华", "quantity": 1 }
    ]
  },
  "levelUp": {
    "triggered": true,
    "newLevel": 6,
    "statsGained": {
      "maxHp": "+20",
      "maxMp": "+15",
      "attack": "+5"
    }
  },
  "newCollections": [
    { "category": "creature", "id": "deep_crab", "name": "深海蟹怪" }
  ],
  "narrative": "战斗结束，你战胜了深海蟹怪！在它的残骸中，你发现了闪闪发光的水之精华..."
}
```

---

## 七、场景6：境界突破

### 7.1 突破流程

```
玩家达到Lv.10 + 拥有突破丹 + 战斗次数足够
                       │
                       ▼
              ┌────────────────┐
              │ 显示突破界面   │
              │ 确认消耗材料   │
              └───────┬────────┘
                      │
                      ▼
              ┌────────────────┐
              │ 执行突破       │
              │ - 消耗突破丹   │
              │ - 更新境界     │
              │ - 重算属性     │
              └───────┬────────┘
                      │
                      ▼
              ┌────────────────┐
              │ AI生成境界文档 │
              │ - 突破描述     │
              │ - 新能力说明   │
              │ - 修炼感悟     │
              └───────┬────────┘
                      │
                      ▼
              ┌────────────────┐
              │ 解锁新内容     │
              │ - 新技能       │
              │ - 新区域       │
              │ - 新副本       │
              └───────┬────────┘
                      │
                      ▼
                 播放突破动画
                 显示境界文档
```

---

## 八、数据流总结

```
┌─────────────────────────────────────────────────────────────────────┐
│                          数据流架构                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────┐      ┌─────────────┐      ┌─────────────┐            │
│   │  前端   │ ←──→ │ API Routes  │ ←──→ │  Prisma     │            │
│   │ (React) │      │ (Next.js)   │      │  (ORM)      │            │
│   └─────────┘      └──────┬──────┘      └──────┬──────┘            │
│                           │                     │                   │
│                           │                     ▼                   │
│                           │              ┌─────────────┐            │
│                           │              │ PostgreSQL  │            │
│                           │              └─────────────┘            │
│                           │                                         │
│                           ▼                                         │
│                    ┌─────────────┐                                  │
│                    │ lib/game/   │ ← 游戏核心逻辑                   │
│                    │ - battle.ts │   (纯计算，无IO)                 │
│                    │ - player.ts │                                  │
│                    │ - skills.ts │                                  │
│                    └──────┬──────┘                                  │
│                           │                                         │
│                           ▼                                         │
│                    ┌─────────────┐      ┌─────────────┐            │
│                    │ lib/ai/     │ ───→ │ Claude API  │            │
│                    │ generator   │ ←─── │             │            │
│                    └─────────────┘      └─────────────┘            │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

> 📝 本文档描述了玩家与系统的主要交互场景和执行逻辑，为开发提供参考。
