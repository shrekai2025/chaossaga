# ChaosSaga - 文档一致性检查报告

> 检查日期: 2026-02-08
> 检查范围: GDD主文档 + 12个系统设计文档 + Prisma Schema

---

## 一、已修复的问题

| # | 问题 | 位置 | 修复内容 |
|---|------|------|----------|
| ✅1 | 境界数量错误 | GDD §1.1, §2.2 | "11大境界"→"10大境界"(实际表格只有10个) |
| ✅2 | 元素克制描述不统一 | GDD §4.3 | "火克木、木克土"→"火克风、风克土"，与Prisma Element枚举(wind)和doc04 ELEMENT_CHART一致 |
| ✅3 | 元素克制缺暗光 | GDD §4.3 | 补充"暗↔光互克"，与doc04一致 |
| ✅4 | AI系统章节过时 | GDD §九 | 重写为"AI与传统计算分工"，明确AI叙事/传统算法分工 |
| ✅5 | 缺少系统索引 | GDD | 新增§十二"深化系统索引"，链接12个详细文档 |
| ✅6 | API路由不完整 | GDD §13.3 | 扩展至25个API端点，覆盖所有系统 |
| ✅7 | 项目结构过时 | GDD §13.4 | 重写项目结构，对应新增系统和data目录 |
| ✅8 | 开发路线图过时 | GDD §十四 | 重写为迭代开发模式，链接development-plan.md |
| ✅9 | doc01章节编号重复 | 01-ai-prompt-system.md | 修复全部章节编号(一~九)和小节编号 |

---

## 二、Prisma Schema 缺失表（需在开发时补充）

以下表在详细设计文档中定义了数据结构，但 **当前 schema.prisma 中不存在**：

| 缺失表 | 来源文档 | 用途 | 开发阶段 |
|--------|----------|------|----------|
| `PlayerAdventure` | 03-adventure-events §七 | 奇遇事件记录(eventId/选择/结果/冷却) | 迭代2 |
| `NpcRelation` | 05-npc-interaction §六 | NPC好感度(亲密度值/记忆摘要/互动历史) | 迭代1 |
| `PlayerReputation` | 08-reputation-faction §五 | 声望数据(势力/声望值/等级/daily caps) | 迭代3 |
| `PlayerAchievement` | 11-achievement-title §五 | 成就进度(条件进度/解锁状态/领取奖励) | 迭代3 |
| `PlayerTitle` | 11-achievement-title §五 | 称号(解锁/装备中/效果) | 迭代3 |
| `Shop` / `ShopItem` | 12-shop-trade | 商店配置(类型/刷新/库存) | 迭代1 |

> 📌 这些表不需要现在添加。按开发计划，在对应迭代开始时再迁移 Schema 即可。当前 Schema 已覆盖 MVP 所需的全部表。

---

## 三、尚未创建详细设计文档的系统

以下系统在 GDD 中有概要设计，但 **没有** 在 `docs/systems/` 中创建独立的详细设计文档：

| 系统 | GDD 位置 | 详细程度评估 | 是否需要独立文档 |
|------|----------|-------------|----------------|
| 技能系统 | GDD §五 | 中 - 有分类、数据结构、示例列表 | ⚠️ 建议 - 需补充技能升级公式、技能树、技能槽机制 |
| 召唤兽系统 | GDD §七 | 低 - 只有概要和进化路线 | ⚠️ 建议 - 需补充属性计算、战斗参与机制、进化条件数据 |
| 图鉴收集系统 | GDD §十 | 低 - 只有分类和奖励类型 | ⚠️ 建议 - 需补充图鉴加成公式、里程碑阈值、系列列表 |
| 任务系统 | 旧文档/quest-system | 高 - 旧文档较完整 | ✅ 可用 - 旧文档已足够详细，开发时参考即可 |

> 📌 建议：技能系统、召唤兽系统和图鉴系统可以在对应开发迭代**开始前**再补充详细文档，不阻塞 MVP 和迭代1。

---

## 四、文档间数据一致性校验

### 4.1 属性公式一致性 ✅

| 公式 | GDD §3.3 | doc04 §二 | 结论 |
|------|----------|-----------|------|
| 最大HP | (100+等级×20)×境界系数+装备+图鉴 | Math.floor((100+level*20)*coeff)+bonus | ✅ 一致 |
| 最大MP | (80+等级×15)×境界系数+装备+图鉴 | Math.floor((80+level*15)*coeff)+bonus | ✅ 一致 |
| 攻击力 | (10+等级×5)×境界系数+武器+图鉴 | Math.floor((10+level*5)*coeff)+bonus | ✅ 一致 |
| 防御力 | (5+等级×3)×境界系数+防具+图鉴 | Math.floor((5+level*3)*coeff)+bonus | ✅ 一致 |
| 速度 | 50+等级×2+装备 | 50+level*2+bonus | ✅ 一致 |
| 升级经验 | 100×(等级^1.5) | Math.floor(100*Math.pow(level,1.5)) | ✅ 一致 |

### 4.2 伤害计算一致性 ✅

| 步骤 | GDD §4.3 | doc04 §四 | 结论 |
|------|----------|-----------|------|
| 基础伤害 | 攻击力×技能倍率 | attacker.attack*skill.damageRatio | ✅ 一致 |
| 防御减伤 | 防御/(防御+100) | defense/(defense+100) | ✅ 一致 |
| 暴击 | ×暴击伤害倍率 | ×attacker.critDamage | ✅ 一致 |
| 属性克制 | ±30% | 1.3/0.7 | ✅ 一致 |
| 随机浮动 | 0.9~1.1 | 0.9+Math.random()*0.2 | ✅ 一致 |

doc04额外增加了环境加成和状态效果两个步骤（GDD中未提及但不矛盾，属于深化）。

### 4.3 元素克制表一致性 ✅（已修复）

| 关系 | GDD §4.3（修复后） | doc04 ELEMENT_CHART | Prisma Element枚举 |
|------|-------------------|--------------------|--------------------|
| 水克火 | ✅ | water→fire:1.3 | ✅ water/fire |
| 火克风 | ✅ | fire→wind:1.3 | ✅ fire/wind |
| 风克土 | ✅ | wind→earth:1.3 | ✅ wind/earth |
| 土克水 | ✅ | earth→water:1.3 | ✅ earth/water |
| 暗↔光 | ✅ | dark→light:1.3, light→dark:1.3 | ✅ dark/light |

### 4.4 境界系数一致性 ✅

| 境界 | GDD §2.2 | doc04 REALM_COEFFICIENTS | Prisma Player.realm |
|------|----------|------------------------|--------------------|
| 海洋级 | 1.0x | ocean: 1.0 | ✅ "ocean" |
| 陆地级 | 2.0x | land: 2.0 | ✅ (String) |
| 荒芜级 | 4.0x | barren: 4.0 | ✅ |
| 行星级 | 8.0x | planet: 8.0 | ✅ |
| 恒星级 | 16.0x | star: 16.0 | ✅ |
| 银河级 | 32.0x | galaxy: 32.0 | ✅ |
| 超越级 | 64.0x | beyond: 64.0 | ✅ |
| 洪荒级 | 128.0x | ancient: 128.0 | ✅ |
| 空灵级 | 256.0x | void: 256.0 | ✅ |
| 元初级 | 512.0x | origin: 512.0 | ✅ |

共10个境界，全部匹配。

### 4.5 装备品质一致性 ✅

| 品质 | GDD §6.2 | doc06 §一 | Prisma Quality枚举 |
|------|----------|-----------|-------------------|
| 普通/白/1.0x | ✅ | ✅ | common |
| 优秀/绿/1.2x | ✅ | ✅ | uncommon |
| 稀有/蓝/1.5x | ✅ | ✅ | rare |
| 史诗/紫/2.0x | ✅ | ✅ | epic |
| 传说/橙/3.0x | ✅ | ✅ | legendary |
| 神话/红/5.0x | ✅ | ✅ | mythic |

### 4.6 AI分工一致性 ✅

| 文档 | AI不参与战斗计算 | AI负责叙事 | 模板引擎战斗叙事 |
|------|-----------------|-----------|-----------------|
| GDD §九 | ✅ 明确声明 | ✅ | ✅ |
| doc01 §二 | ✅ 详细分工表 | ✅ | ✅ |
| doc02 全文 | ✅ "零API调用" | - | ✅ §八模板引擎 |
| doc04 全文 | ✅ "全部传统数值计算" | - | - |

---

## 五、Prisma Schema 与 GDD 数据结构匹配度

| GDD概念 | Prisma Model | 匹配度 | 备注 |
|---------|-------------|--------|------|
| 玩家属性 | Player | ✅ 完全匹配 | 所有属性字段都有 |
| 技能 | Skill + PlayerSkill | ✅ 完全匹配 | 支持装备到技能栏 |
| 物品 | Item + Inventory | ✅ 基本匹配 | 词缀通过customData JSON存储 |
| 装备 | PlayerEquipment | ✅ 完全匹配 | 6个装备槽位 |
| 召唤兽 | Pet + PlayerPet | ✅ 基本匹配 | |
| 区域 | Area + PlayerArea | ✅ 完全匹配 | 含AI生成的背景 |
| 任务 | Quest + PlayerQuest | ✅ 完全匹配 | 支持任务链 |
| 敌人 | Enemy | ✅ 完全匹配 | 含掉落表/属性 |
| NPC | Npc | ⚠️ 部分匹配 | 缺少NpcRelation(好感度) |
| 图鉴 | Collection | ✅ 基本匹配 | |
| 战斗记录 | BattleLog | ✅ 完全匹配 | |
| 剧本文档 | Document | ✅ 完全匹配 | |

---

## 六、框架层面欠缺项（需在开发中补充）

### 6.1 技术架构欠缺

| 欠缺项 | 重要性 | 建议处理时机 | 说明 |
|--------|--------|-------------|------|
| 用户认证方案 | 高 | 迭代4 | 建议用 NextAuth.js，支持邮箱/OAuth |
| 错误处理规范 | 中 | MVP | 统一API错误格式、前端错误边界 |
| 日志/监控 | 中 | 迭代4 | AI调用监控、错误追踪(Sentry) |
| 测试策略 | 中 | MVP起 | 战斗引擎单元测试、API集成测试 |
| CI/CD | 低 | 迭代4 | GitHub Actions + Vercel |
| 速率限制 | 中 | 迭代1 | AI API调用频率限制、防滥用 |

### 6.2 游戏设计欠缺

| 欠缺项 | 重要性 | 建议处理时机 | 说明 |
|--------|--------|-------------|------|
| 技能升级/进化机制 | 中 | 迭代2 | 技能如何变强？使用次数？消耗资源？ |
| 召唤兽属性计算 | 低 | 迭代2 | 召唤兽如何参与伤害计算？独立行动还是辅助？ |
| 图鉴加成具体公式 | 低 | 迭代2 | 收集N个生物图鉴→+X%伤害，具体数值？ |
| 死亡/失败惩罚 | 中 | MVP | 战斗失败扣什么？金币？经验？返回城镇？ |
| 逃跑成功率公式 | 低 | MVP | GDD提到"有失败率"但未定义公式 |
| 多区域传送机制 | 低 | 迭代3 | 区域间如何切换？自由传送？需要条件？ |

---

## 七、总结

### 文档健康度评分

| 维度 | 评分 | 说明 |
|------|------|------|
| 数值公式一致性 | ⭐⭐⭐⭐⭐ | 所有核心公式在GDD和详细文档间完全一致 |
| AI/算法分工清晰度 | ⭐⭐⭐⭐⭐ | 4个文档反复确认，边界清晰 |
| Schema与设计匹配度 | ⭐⭐⭐⭐ | MVP覆盖完整，后续表按需添加 |
| 系统覆盖完整度 | ⭐⭐⭐⭐ | 12个详细文档覆盖核心系统，3个次要系统待补充 |
| 章节编号规范性 | ⭐⭐⭐⭐⭐ | 已修复所有编号问题 |
| 可编码程度 | ⭐⭐⭐⭐⭐ | 详细文档含TypeScript代码、数据结构、算法 |

### 结论

**文档体系已具备开发条件。** 核心系统（战斗引擎、敌人AI、数值平衡、AI集成、NPC交互、装备系统、奇遇事件、环境效果、声望、成就、商店、状态管理、新手引导）均有可直接编码的详细设计。3个次要系统（技能升级、召唤兽、图鉴）可在对应迭代中再补充。Prisma Schema的迭代扩展策略清晰，不影响MVP开发启动。

---

> 📝 本报告随开发进展更新。发现新的不一致时请补充到本文档。
