# ChaosSaga - 完整游戏设计文档

> **AI驱动的回合制文字冒险游戏**
> 版本: 3.0 | 更新日期: 2026-02-09

---

## 目录

1. [游戏概述](#一游戏概述)
2. [世界观设定](#二世界观设定)
3. [玩家系统](#三玩家系统)
4. [战斗系统](#四战斗系统)
5. [技能系统](#五技能系统)
6. [装备与道具系统](#六装备与道具系统)
7. [召唤兽系统](#七召唤兽系统)
8. [区域与关卡系统](#八区域与关卡系统)
9. [AI与传统计算分工](#九ai与传统计算分工)
10. [图鉴收集系统](#十图鉴收集系统)
11. [经济系统](#十一经济系统)
12. [深化系统索引](#十二深化系统索引)
13. [交互架构](#十三交互架构)
14. [开发路线图](#十四开发路线图)

---

## 一、游戏概述

### 1.1 核心定位

**ChaosSaga** 是一款以 **AI Game Master（游戏主持人）** 为核心的聊天式文字冒险游戏。

**核心体验：像和一个全知全能的 DnD 城主对话。** 玩家通过自然语言与 AI 交互，AI 扮演游戏主持人，实时创造世界、推进剧情、主持战斗、扮演 NPC。

**四大支柱：**

- **AI Game Master**：整个游戏是与 AI 的对话，AI 解读玩家意图并驱动一切
- **玩家共创世界**：玩家可用自然语言描述场景，AI 生成完整冒险区域（地图、敌人、NPC、任务、奇遇）
- **双层引擎**：传统算法处理标准数值计算（高效可靠），AI 处理非标准创意效果（灵活自由）
- **GM 自由度**：玩家可用自然语言修改任何游戏数值，拥有完全的掌控权

### 1.2 三种交互模式

| 模式 | 说明 | 示例 |
|------|------|------|
| 自然语言探索 | 玩家用自然语言描述行动，AI 推进剧情 | "我去海边看看有没有什么有趣的东西" |
| 战斗模式 | 回合制战斗，可用自然语言或快捷按钮 | "用冰箭术攻击" 或点击 [冰箭术] |
| GM 模式 | 自由修改任何游戏数值，测试/作弊 | "把我等级改成10" "/gm 给我1000金币" |

### 1.3 核心游戏循环

```
┌─────────────────────────────────────────────────────────────────┐
│   对话探索 → 遭遇事件 → 战斗/交互 → 获得奖励 → 变强 → 更深冒险  │
└─────────────────────────────────────────────────────────────────┘

玩家共创闭环：
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│ 描述场景  │ →  │ AI生成区域│ →  │ 探索冒险  │ →  │ 获得奖励  │
│(自然语言) │    │(地图/NPC) │    │(战斗/任务)│    │(装备/经验)│
└──────────┘    └──────────┘    └──────────┘    └──────────┘
      ↑                                              │
      └──────────────── 变强，探索新区域 ──────────────┘
```

### 1.4 目标用户

- 喜欢文字冒险和角色扮演的玩家
- 对 AI 生成内容感兴趣的用户
- 喜欢 DnD/TRPG 但找不到城主的玩家
- 偏好轻量级、碎片化游戏体验的移动端用户

---

## 二、世界观设定

### 2.1 背景故事

**平行宇宙**

- 类似现实宇宙的平行世界，但存在魔法和明确的力量体系
- 人类与众多强大种族共存
- 强者可跨越星空，出现在任何星球

**起源星球**

- 类似地球的星球
- 所有生物从海洋发源，经漫长进化成为强大存在
- 力量体系也从海洋开始

### 2.2 力量体系（10大境界）

| 境界      | 战力范围 | 等级   | 系数   | 特点                   |
| --------- | -------- | ------ | ------ | ---------------------- |
| 海洋级    | 1-1K     | 1-10   | 1.0x   | 起源之力，与水元素共鸣 |
| 陆地级    | 1K-5K    | 11-20  | 2.0x   | 踏足大地，掌控土石     |
| 荒芜级    | 5K-20K   | 21-30  | 4.0x   | 适应极端环境，意志坚韧 |
| 行星级    | 20K-100K | 31-40  | 8.0x   | 影响一颗星球的力量     |
| 恒星级 ⭐ | 100K-1M  | 41-50  | 16.0x  | 跨星球统一叫法开始     |
| 银河级    | 1M-50M   | 51-60  | 32.0x  | 星系级别的存在         |
| 超越级    | 50M-500M | 61-70  | 64.0x  | 超越常规法则           |
| 洪荒级    | 500M-5B  | 71-80  | 128.0x | 远古之力觉醒           |
| 空灵级    | 5B-100B  | 81-90  | 256.0x | 虚空行走，灵魂升华     |
| 元初级    | 100B+    | 91-100 | 512.0x | 回归本源，创世之力     |

> 📌 注：每个星球的力量体系叫法不同，但恒星级以上统一命名

### 2.3 境界突破条件

| 条件类型 | 说明                       |
| -------- | -------------------------- |
| 等级达标 | 当前等级需达到境界等级上限 |
| 突破材料 | 需拥有对应境界突破丹       |
| 战斗经验 | 当前境界战斗次数达到要求   |

---

## 三、玩家系统

### 3.1 角色创建

**基础信息**
| 属性 | 说明 |
|------|------|
| 名字 | 玩家自定义 |
| 种族 | 人类（初始）/ 其他种族（后期解锁）|
| 背景 | 与海洋的联系程度（影响初始技能和奇遇概率）|

**默认主角设定参考**

- 人类小女孩，与海洋有着特殊联系
- 海洋级时奇遇概率大幅提升
- 可获得成长型海兽召唤物

### 3.2 玩家属性

| 属性类别 | 属性列表                                   |
| -------- | ------------------------------------------ |
| 基础属性 | HP（血量）、MP（魔法量）、当前HP/MP        |
| 战斗属性 | 攻击力、防御力、速度、暴击率、暴击伤害     |
| 境界信息 | 当前境界、境界进度(0-100%)                 |
| 环境信息 | 地理位置、天气、时间、季节（用于关卡生成） |

### 3.3 属性计算规则

| 属性   | 计算方式                                       |
| ------ | ---------------------------------------------- |
| 最大HP | (100 + 等级×20) × 境界系数 + 装备HP + 图鉴HP   |
| 最大MP | (80 + 等级×15) × 境界系数 + 装备MP + 图鉴MP    |
| 攻击力 | (10 + 等级×5) × 境界系数 + 武器攻击 + 图鉴攻击 |
| 防御力 | (5 + 等级×3) × 境界系数 + 防具防御 + 图鉴防御  |
| 速度   | 50 + 等级×2 + 装备速度                         |

### 3.4 经验与升级

| 项目         | 规则                                     |
| ------------ | ---------------------------------------- |
| 升级所需经验 | 100 × (当前等级^1.5)                     |
| 战斗经验获取 | 敌人基础经验 × (1 + 难度系数) × 经验加成 |

---

## 四、战斗系统

### 4.1 战斗流程

```
【战斗开始】
    │
    ▼
【回合开始】← ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐
    │                              │
    ▼                              │
【速度排序】决定行动顺序            │
    │                              │
    ▼                              │
【玩家回合】                        │
  ├─ 选择行动                      │
  ├─ 执行行动                      │
  └─ 结算伤害/效果                 │
    │                              │
    ▼                              │
【敌人回合】                        │
  ├─ AI选择行动                    │
  ├─ 执行行动                      │
  └─ 结算伤害/效果                 │
    │                              │
    ▼                              │
【回合结束】                        │
  ├─ 结算持续效果（中毒/灼烧等）   │
  ├─ 检查胜负条件                  │
  └─ 未结束 → ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘
    │
    ▼
【战斗结束】→ 结算奖励
```

### 4.2 战斗行动选项

| 行动     | 说明                     | 消耗     |
| -------- | ------------------------ | -------- |
| 普通攻击 | 基础物理伤害             | 无       |
| 技能     | 释放主动技能             | MP       |
| 道具     | 使用消耗品               | 道具数量 |
| 防御     | 本回合减伤50%            | 无       |
| 逃跑     | 尝试逃离战斗（有失败率） | 无       |

### 4.3 伤害计算逻辑

| 步骤        | 计算规则                               |
| ----------- | -------------------------------------- |
| 1. 基础伤害 | 攻击力 × 技能倍率                      |
| 2. 防御减伤 | 敌方防御 / (敌方防御 + 100)            |
| 3. 暴击判定 | 触发时伤害 × 暴击伤害倍率              |
| 4. 属性克制 | 水克火、火克风、风克土、土克水（±30%），暗↔光互克 |
| 5. 随机浮动 | 最终伤害 × (0.9 ~ 1.1)                 |

### 4.4 状态效果

| 效果 | 类型 | 说明               |
| ---- | ---- | ------------------ |
| 中毒 | 减益 | 每回合损失3%最大HP |
| 灼烧 | 减益 | 每回合损失5%最大HP |
| 冰冻 | 控制 | 跳过1回合行动      |
| 眩晕 | 控制 | 跳过1回合行动      |
| 减速 | 减益 | 速度降低30%        |
| 护盾 | 增益 | 吸收一定伤害       |
| 再生 | 增益 | 每回合恢复5%最大HP |

---

## 五、技能系统

### 5.1 技能分类

| 类型     | 特点                     | 示例                   |
| -------- | ------------------------ | ---------------------- |
| 主动技能 | 消耗MP释放，有冷却时间   | 梦幻冲击、冰箭术、石化 |
| 场地技能 | 改变战场环境，持续多回合 | 海洋洗刷刷             |
| 被动技能 | 永久生效，无需操作       | 接触大海法力无边       |

### 5.2 技能数据结构

| 字段     | 说明                 |
| -------- | -------------------- |
| 名称     | 技能名称             |
| 类型     | 主动/场地/被动       |
| 属性     | 水/火/土/风/暗/光    |
| MP消耗   | 释放消耗的魔法值     |
| 冷却时间 | 使用后需等待的回合数 |
| 伤害倍率 | 基于攻击力的伤害系数 |
| 目标类型 | 单体/群体/自身       |
| 附加效果 | 眩晕、减速、中毒等   |

### 5.3 技能列表示例

| 技能名   | MP  | CD  | 倍率 | 效果           |
| -------- | --- | --- | ---- | -------------- |
| 梦幻冲击 | 30  | 2   | 1.5x | 30%眩晕1回合   |
| 投石术   | 20  | 0   | 1.2x | 无             |
| 冰箭术   | 25  | 1   | 1.3x | 减速2回合      |
| 地震术   | 50  | 3   | 1.0x | 群体攻击       |
| 暗影箭   | 35  | 2   | 1.8x | 无视30%防御    |
| 石化     | 60  | 4   | 0    | 石化2回合      |
| 千年乌鱼 | 40  | 3   | 2.0x | 召唤海兽攻击   |
| 节气召唤 | 45  | 2   | 可变 | 效果随季节变化 |

### 5.4 技能获取方式

- 境界突破解锁
- 奇遇事件获得
- NPC传授
- 技能书学习
- 召唤兽共享

---

## 六、装备与道具系统

### 6.1 装备分类

| 类型     | 说明              | 示例     |
| -------- | ----------------- | -------- |
| 武器     | 主要攻击装备      | 骑鹅圈   |
| 防具     | 头/身/手/脚四部位 | 玄武甲   |
| 首饰     | 属性加成饰品      | 小水滴   |
| 特效套装 | 集齐触发特殊效果  | 光明套装 |

### 6.2 装备品质

| 品质 | 颜色 | 属性加成倍率 |
| ---- | ---- | ------------ |
| 普通 | 白   | 1.0x         |
| 优秀 | 绿   | 1.2x         |
| 稀有 | 蓝   | 1.5x         |
| 史诗 | 紫   | 2.0x         |
| 传说 | 橙   | 3.0x         |
| 神话 | 红   | 5.0x         |

### 6.3 道具分类

| 类型     | 说明                 |
| -------- | -------------------- |
| 消耗品   | 回复药剂、增益药水   |
| 材料     | 强化石、突破丹       |
| 特殊物品 | 任务道具、未鉴定物品 |
| 技能书   | 学习新技能           |

---

## 七、召唤兽系统

### 7.1 基础设定

**成长型召唤兽特点**

- 与玩家一同成长
- 可进化多个形态
- 拥有独立技能树
- 可参与战斗或探索

### 7.2 海兽进化路线

```
            ┌─→ 玄武幼崽 → 玄武 → 神玄武
小海龟 ────┤
            └─→ 海蛇幼崽 → 蛟龙 → 应龙
```

### 7.3 召唤兽系统规则

| 规则     | 说明                       |
| -------- | -------------------------- |
| 获取途径 | 海洋级奇遇（主角特殊背景） |
| 升级方式 | 随玩家战斗获得经验         |
| 进化条件 | 等级达标 + 进化材料        |
| 战斗参与 | 可选择出战或休息           |

---

## 八、区域与关卡系统

### 8.1 环境要素驱动

关卡根据玩家当前环境要素动态生成：

| 要素     | 可选值                      |
| -------- | --------------------------- |
| 地理位置 | 海边/森林/城市/沙漠/雪山... |
| 天气     | 晴/雨/雪/雷暴/迷雾...       |
| 时间     | 早晨/中午/傍晚/深夜         |
| 季节     | 春/夏/秋/冬                 |

### 8.2 关卡生成示例

| 环境组合                    | 生成关卡                       |
| --------------------------- | ------------------------------ |
| 海边 + 暴风雨 + 深夜 + 夏季 | 深海巨兽来袭！风暴中的海怪入侵 |
| 森林 + 晴天 + 早晨 + 春季   | 精灵的试炼，森林迷宫探索       |
| 城市 + 雾天 + 傍晚 + 秋季   | 迷雾中的暗影刺客，城市追逐战   |

### 8.3 区域数据结构

| 字段     | 说明                     |
| -------- | ------------------------ |
| 区域名称 | 如"珊瑚海湾"             |
| 区域类型 | 海域/陆地/城镇/秘境      |
| 境界要求 | 进入该区域的最低境界     |
| 核心矛盾 | 该区域正在发生的主要冲突 |
| 玩家目标 | 玩家在此区域的任务目标   |
| 关键NPC  | 2-3个重要角色及立场      |
| 可用副本 | 该区域的副本列表         |
| BOSS列表 | 区域BOSS                 |

### 8.4 区域示例：珊瑚海湾

| 项目     | 内容                                              |
| -------- | ------------------------------------------------- |
| 境界要求 | 海洋级                                            |
| 核心矛盾 | 渔民与海妖族的领地争端                            |
| 玩家目标 | 调查失踪的渔船，揭开海妖的秘密                    |
| 关键NPC  | 老渔夫阿海(任务)、海妖公主(敌/友)、神秘商人(商店) |
| 可用副本 | 沉船遗迹、海妖巢穴                                |
| BOSS     | 深海蟹将、海妖女王                                |

### 8.5 区域来源：种子 + AI 动态生成

游戏中的区域有两种来源，使用**统一的节点数据格式**：

| 来源 | 说明 | 时机 |
| ---- | ---- | ---- |
| 种子数据 | 预置的起始区域（珊瑚海湾），确保新手体验稳定可控 | 数据库初始化时 |
| AI 动态生成 | 玩家描述场景后，AI 调用 `generate_area` 实时创建 | 游戏进行中 |

两者写入相同的 Area / AreaNode / AreaNodeConnection 表，后续所有工具（`get_area_info`、`move_to_node`、`start_battle`）统一读取，无需区分来源。

**节点 data 字段按 type 遵循统一结构：**

| type | data 结构 |
| ---- | --------- |
| battle | `{ enemyTemplates: [{ name, level, element, minCount, maxCount, description }] }` |
| boss | `{ boss: { name, level, element, stats, skills, drops } }` |
| npc | `{ npc: { id, name, role, personality, greeting, dialogTopics } }` |
| shop | `{ npc: {...}, shopItems: [{ name, type, quality, price, stats }] }` |
| event | `{ events: [{ id, name, type, description, reward?, loot? }] }` |
| safe | `{ hints: ["环境线索"] }` |

### 8.6 副本类型

| 类型     | 说明             | 刷新规则     |
| -------- | ---------------- | ------------ |
| 随机冒险 | AI生成，基于环境 | 无限制       |
| BOSS战   | 单BOSS挑战       | 每日3次      |
| 剧情副本 | 主线故事         | 一次性       |
| 试炼塔   | 无限层数挑战     | 每日重置进度 |

---

## 九、AI Game Master 与传统引擎分工

### 9.1 核心设计哲学

**AI 是创意裁判，引擎是可靠计算器。**

ChaosSaga 的核心架构将游戏逻辑分为两层：

- **传统游戏引擎**：处理标准的、模式化的、可精确计算的功能（伤害公式、属性计算、概率判定）
- **AI Game Master**：处理非标准的、创意的、上下文相关的功能（剧情推进、世界生成、特殊效果执行）

| 维度 | AI Game Master (Claude Function Calling) | 传统游戏引擎 |
|------|------------------------------------------|-------------|
| 战斗 | 通过 `execute_battle_action` 工具调用引擎，生成战斗叙事 | 伤害计算、敌人AI决策、掉落判定、回合管理 |
| 世界 | 根据玩家描述生成完整区域（`generate_area`） | 区域数据存储、节点连接 |
| 任务 | NPC对话中生成任务（`create_quest`），更新进度（`update_quest`） | 任务状态管理、奖励发放 |
| 剧情 | 所有叙事文本、NPC对话、奇遇描述 | - |
| 特殊效果 | 探测并执行非标准效果，直接修改数据（`modify_player_data`） | 标准BUFF/DEBUFF、属性加成 |
| GM模式 | 解析自然语言GM指令，修改任意数值 | - |

### 9.2 AI Function Calling Tools（15个）

AI Game Master 通过 Function Calling 与游戏系统交互，**不直接操作数据库**，而是调用预定义的工具函数：

**查询类工具：**

| # | 工具名 | 功能 | 说明 |
|---|--------|------|------|
| 1 | `get_player_state` | 获取玩家完整状态 | 属性、装备、技能、背包、位置 |
| 2 | `get_area_info` | 获取当前区域信息 | 地图节点、敌人、NPC、事件 |
| 3 | `get_battle_state` | 获取战斗状态 | 双方HP/MP、回合数、BUFF |

**行动类工具：**

| # | 工具名 | 功能 | 说明 |
|---|--------|------|------|
| 4 | `execute_battle_action` | 执行战斗行动 | 调用战斗引擎计算，返回结果 |
| 5 | `start_battle` | 发起战斗 | 指定敌人，初始化战斗状态 |
| 6 | `use_item` | 使用物品 | 消耗品、装备穿戴 |
| 7 | `move_to_node` | 移动到区域节点 | 触发该节点事件 |
| 8 | `interact_npc` | 与NPC交互 | 对话、购买、接任务 |
| 9 | `enhance_equipment` | 强化装备 | 消耗材料，调用强化算法 |

**生成类工具：**

| # | 工具名 | 功能 | 说明 |
|---|--------|------|------|
| 10 | `generate_area` | 生成冒险区域 | 根据玩家描述生成完整地图 |
| 11 | `create_quest` | 创建任务 | NPC对话中动态生成任务 |
| 12 | `update_quest` | 更新任务进度 | 检测并推进任务目标 |

**修改类工具：**

| # | 工具名 | 功能 | 说明 |
|---|--------|------|------|
| 13 | `modify_player_data` | 修改玩家数据 | GM模式 + 非标准效果执行 |
| 14 | `add_item` | 添加物品 | 奖励发放、任务奖励 |
| 15 | `send_narrative` | 发送叙事文本 | 纯文本输出，无副作用 |

### 9.3 玩家共创世界：区域生成

玩家可用自然语言描述想要探索的区域，AI 生成完整冒险地图：

**玩家输入示例：**
> "我在云南原始森林，看到参天古木和缠绕的藤蔓，环境潮湿闷热，满是虫鸣鸟叫。这里可能有很多植物系的野怪，也会有boss，我也会接到任务，也有奇遇。生成这个区域的冒险地图。"

**AI 调用 `generate_area` 工具生成：**

```json
{
  "name": "云南原始密林",
  "description": "亚热带原始森林，空气潮湿...",
  "recommendedLevel": 15,
  "nodes": [
    { "id": "entrance", "name": "林间小径入口", "type": "safe", "description": "..." },
    { "id": "vine_area", "name": "藤蔓迷宫", "type": "battle", "enemies": ["缠藤怪", "毒花精"], "description": "..." },
    { "id": "herb_elder", "name": "采药老人", "type": "npc", "npcName": "药叔", "dialogue": "啊冒险者，你能否帮我找到三株千年灵芝？作为回报我会教你一个特殊的解毒术...", "quest": {...} },
    { "id": "ancient_tree", "name": "远古巨树", "type": "boss", "enemy": "树灵王", "description": "..." },
    { "id": "hidden_spring", "name": "隐秘灵泉", "type": "event", "description": "你发现了一处隐藏的灵泉..." }
  ],
  "connections": [
    ["entrance", "vine_area"],
    ["vine_area", "herb_elder"],
    ["vine_area", "ancient_tree"],
    ["herb_elder", "hidden_spring"]
  ]
}
```

### 9.4 NPC 对话式任务

NPC 任务不是静态的任务列表，而是在 AI 生成的自然对话中产生：

**对话示例：**
> **药叔**（慈祥地看着你）：
> "年轻人，你来得正好。老朽需要三株千年灵芝来配制解毒丹，可这森林深处太危险了...你能否帮我寻来？作为回报，我可以教你一套独门解毒之法，在这毒瘴弥漫的密林中，可保你性命无虞。"
>
> *[接受任务]* *[询问更多]* *[拒绝]*

**任务类型包括：**
- **采集类**：找到特定物品（药草、矿石、掉落物）
- **击败类**：消灭指定BOSS或一定数量怪物
- **智力问答类**：解谜、回答问题、推理判断
- **护送类**：保护NPC安全到达目的地
- **探索类**：发现隐藏区域或秘密

### 9.5 非标准效果执行

传统游戏系统处理标准效果（BUFF/DEBUFF、属性加成、固定伤害），而 AI 负责探测并执行**无法预先编码的特殊效果**：

**示例1：濒死回复**
> 玩家拥有道具"不死鸟之泪"，描述为"当持有者生命垂危时，自动回复满血，一次性消耗"。
>
> - AI 在每次战斗结果后检查：玩家HP < 10%？持有该道具？
> - 触发时：调用 `modify_player_data` 将HP设为maxHp，调用 `use_item` 消耗道具
> - 生成叙事："就在致命一击落下的瞬间，你怀中的不死鸟之泪突然碎裂，温暖的金色光芒包裹全身..."

**示例2：自定义诅咒**
> AI 生成的奇遇中，玩家被施加"贪婪之咒"——每次获得金币减半。
>
> - 效果存储在 `Item.specialEffect` 字段（JSON描述）
> - AI 在每次涉及金币的场景中检查该效果并执行
> - 解咒条件也由 AI 判断（如完成特定任务）

### 9.6 GM 模式

玩家可随时使用自然语言修改任何游戏数值：

```
玩家: /gm 把我等级设为50
AI: 已将等级修改为50，属性已重新计算。
    [调用 modify_player_data: {level: 50, 重算HP/MP/攻防}]

玩家: 给我来10把传说级武器
AI: 已添加10把随机传说级武器到背包。
    [调用 add_item x10: 随机传说武器]

玩家: 把这只怪血量改成1
AI: 已将当前敌人HP修改为1。下一击应该就能解决了。
    [调用 modify_player_data: {target: enemy, hp: 1}]
```

> 📌 详细 Prompt 设计与 Tool 定义见 [01-ai-prompt-system.md](systems/01-ai-prompt-system.md)

---

## 十、图鉴收集系统

### 10.1 图鉴分类

| 分类     | 内容                               |
| -------- | ---------------------------------- |
| 生物图鉴 | 海洋生物、陆地生物、魔物、神话生物 |
| 物品图鉴 | 武器、防具、首饰、套装、材料       |
| 技能图鉴 | 已学技能、未解锁技能               |
| 世界图鉴 | 地点、NPC、事件                    |

### 10.2 图鉴奖励机制

| 奖励类型   | 说明                            |
| ---------- | ------------------------------- |
| 单条目奖励 | 首次发现获得经验/金币           |
| 系列奖励   | 集齐某系列获得特殊道具          |
| 里程碑奖励 | 达到收集数量解锁称号/坐骑/技能  |
| 图鉴加成   | 收集越多，对应类型伤害/防御加成 |

---

## 十一、经济系统

### 11.1 货币类型

| 货币 | 获取方式                 | 用途               |
| ---- | ------------------------ | ------------------ |
| 金币 | 战斗掉落、任务、出售物品 | 商店购买、装备强化 |
| 灵石 | 副本奖励、成就、充值     | 高级道具、境界突破 |

### 11.2 产出与消耗

**产出渠道**
| 来源 | 产出 |
|------|------|
| 战斗掉落 | 装备/材料/金币 |
| 副本奖励 | 稀有装备/灵石/技能书 |
| 图鉴奖励 | 特殊道具/称号 |
| 奇遇事件 | 随机奖励 |

**消耗渠道**
| 用途 | 消耗 |
|------|------|
| 装备强化 | 金币 + 强化石 |
| 技能升级 | 金币 + 技能点 |
| 境界突破 | 灵石 + 突破丹 |
| 道具购买 | 金币/灵石 |

### 11.3 副本奖励结构

| 副本类型 | 奖励内容                                           |
| -------- | -------------------------------------------------- |
| 随机冒险 | 经验×难度系数、金币50-200、普通~稀有装备、图鉴发现 |
| BOSS战   | 经验×3、金币500-2000、稀有~传说装备、首杀灵石      |

---

## 十二、深化系统索引

以下详细设计文档包含可直接编码的数据结构、算法和公式：

| # | 系统 | 文档 | 核心内容 |
|---|------|------|----------|
| 01 | AI Prompt 工程 | [01-ai-prompt-system.md](systems/01-ai-prompt-system.md) | Prompt模板、Token管理、上下文组装、容错机制 |
| 02 | 敌人AI行为 | [02-enemy-ai-system.md](systems/02-enemy-ai-system.md) | 行为树、6种人格、权重随机、BOSS多阶段、群体战术 |
| 03 | 奇遇事件 | [03-adventure-events-system.md](systems/03-adventure-events-system.md) | 触发机制、4级事件、保底系统、事件池、AI备选生成 |
| 04 | 难度与数值平衡 | [04-difficulty-balance-system.md](systems/04-difficulty-balance-system.md) | 属性公式、伤害计算链、元素克制、经济平衡、难度等级 |
| 05 | NPC深度交互 | [05-npc-interaction-system.md](systems/05-npc-interaction-system.md) | NPC分类、好感度8级、NPC记忆、AI/模板对话路由 |
| 06 | 装备与套装 | [06-equipment-set-system.md](systems/06-equipment-set-system.md) | 强化系统、词缀系统、套装效果、装备评分 |
| 07 | 环境效果 | [07-environment-effects-system.md](systems/07-environment-effects-system.md) | 天气/时间/季节/地形影响、叠加计算、天气推进 |
| 08 | 声望与势力 | [08-reputation-faction-system.md](systems/08-reputation-faction-system.md) | 声望8级、势力关系矩阵、声望溢出、奖励解锁 |
| 09 | 新手引导 | [09-onboarding-tutorial-system.md](systems/09-onboarding-tutorial-system.md) | 6阶段教学、引导战斗、渐进解锁、提示系统 |
| 10 | 会话状态 | [10-session-state-system.md](systems/10-session-state-system.md) | 三层状态架构、战斗快照、断线恢复、数据同步 |
| 11 | 成就与称号 | [11-achievement-title-system.md](systems/11-achievement-title-system.md) | 成就类别、多阶成就、称号效果、奖励体系 |
| 12 | 商店与交易 | [12-shop-trade-system.md](systems/12-shop-trade-system.md) | 5类商店、价格公式、轮换机制、好感度/声望折扣 |

---

## 十三、交互架构

### 13.1 聊天式交互模型

**整个游戏就是一个聊天窗口。** 玩家与 AI Game Master 对话即是游玩。

```
┌─────────────────────────────────────────────────────────┐
│  ChaosSaga                              [角色状态侧栏]  │
│─────────────────────────────────────────────────────────│
│                                         ┌─────────────┐│
│  GM: 你来到了海边小镇，远处传来海浪声..  │ 等级: 5     ││
│                                         │ HP: 850/850 ││
│  > 我去海边看看                          │ MP: 400/400 ││
│                                         │ 金币: 1200  ││
│  GM: 海边的沙滩上，一只深海蟹怪正在...  │ 位置: 海边  ││
│      [战斗！] [观察] [逃跑]              │             ││
│                                         │ [装备]      ││
│  > 战斗！                                │ [技能]      ││
│                                         │ [背包]      ││
│  GM: 战斗开始！深海蟹怪 向你挥动巨螯！  │ [任务]      ││
│  ──── 第1回合 ────                       │             ││
│  [冰箭术] [火球术] [防御] [使用道具]     │             ││
│                                         └─────────────┘│
│─────────────────────────────────────────────────────────│
│  [输入消息...]                           [发送]        │
└─────────────────────────────────────────────────────────┘
```

**输入方式：**
- **自然语言**：直接打字描述想做的事
- **快捷按钮**：AI 在关键节点提供选项按钮（战斗技能、对话选项等）
- **GM 命令**：以 `/gm` 开头或直接用自然语言修改数值

### 13.2 技术栈

| 层级 | 技术方案 |
|------|----------|
| 全栈框架 | Next.js 15 (App Router) |
| 语言 | TypeScript |
| 样式 | Tailwind CSS |
| 数据库 | PostgreSQL + Prisma ORM (Supabase) |
| AI引擎 | 多模型支持，通过兔子 API 统一接入（OpenAI SDK + Anthropic SDK） |
| 支持模型 | GPT-5.1, GPT-4o-mini, Gemini 3 Pro, Grok 4.1, Claude Opus 4.5, Claude Haiku 4.5 |
| LLM抽象层 | 统一适配器模式：自动路由 OpenAI/Anthropic 格式，标准化 Function Calling |
| 流式传输 | Server-Sent Events (SSE) |
| 部署 | Vercel |

### 13.3 核心API路由（精简版）

聊天式架构下，绝大多数游戏操作通过 AI Game Master 的 Function Calling 完成，API 大幅精简：

| 路由 | 方法 | 说明 |
|------|------|------|
| `/api/game/chat` | POST | **核心端点** - SSE流式返回，AI Game Master处理所有游戏交互 |
| `/api/player` | GET | 获取玩家完整状态（侧栏展示用） |
| `/api/player` | POST | 创建新角色 |
| `/api/player/history` | GET | 获取对话历史（翻页加载） |
| `/api/settings` | GET | 获取 LLM 配置和可用模型列表 |
| `/api/settings` | POST | 更新 LLM 模型/温度/最大token |

**为什么游戏 API 这么少？** 因为战斗、移动、使用物品、NPC交互、任务等操作全部通过 `/api/game/chat` 由 AI 解析意图后调用对应 Tool 完成。前端不需要为每个功能单独调 API。

### 13.4 SSE 数据流

```
客户端                          服务端 (/api/game/chat)
  │                                │
  │── POST {message, playerId} ──→│
  │                                │── 组装上下文(玩家状态+对话历史)
  │                                │── 调用 Claude API (stream)
  │                                │
  │←── SSE: {type:"text"} ────────│  AI 开始回复文本
  │←── SSE: {type:"text"} ────────│  继续流式文本
  │←── SSE: {type:"tool_call"} ──│  AI 决定调用工具
  │                                │── 执行工具(如 start_battle)
  │←── SSE: {type:"tool_result"} ─│  返回工具执行结果
  │←── SSE: {type:"text"} ────────│  AI 基于结果继续叙事
  │←── SSE: {type:"actions"} ─────│  提供快捷按钮选项
  │←── SSE: {type:"state_update"}─│  玩家状态变更通知
  │←── SSE: {type:"done"} ────────│  回合结束
  │                                │
```

### 13.5 项目结构

```
chaossaga/
├── src/
│   ├── app/                          # Next.js App Router
│   │   ├── page.tsx                  # 首页/角色创建
│   │   ├── game/                     # 游戏主页面
│   │   │   └── page.tsx              # 聊天界面(唯一游戏页面)
│   │   ├── api/                      # API Routes
│   │   │   ├── game/
│   │   │   │   └── chat/route.ts     # 核心SSE端点
│   │   │   └── player/
│   │   │       ├── route.ts          # GET/POST 玩家
│   │   │       └── history/route.ts  # 对话历史
│   │   ├── layout.tsx
│   │   └── globals.css
│   │
│   ├── components/                   # UI组件
│   │   ├── ui/                       # 基础组件(Button/Card/Input等)
│   │   ├── chat/                     # 聊天相关组件
│   │   │   ├── ChatWindow.tsx        # 聊天窗口主组件
│   │   │   ├── MessageBubble.tsx     # 消息气泡
│   │   │   ├── ActionButtons.tsx     # 快捷操作按钮
│   │   │   └── StreamingText.tsx     # SSE流式文本显示
│   │   └── game/                     # 游戏状态组件
│   │       ├── PlayerSidebar.tsx     # 角色状态侧栏
│   │       ├── InventoryPanel.tsx    # 背包面板
│   │       ├── SkillPanel.tsx        # 技能面板
│   │       └── QuestPanel.tsx        # 任务面板
│   │
│   └── lib/                          # 核心逻辑
│       ├── ai/                       # AI Game Master
│       │   ├── gamemaster.ts         # GM核心：上下文组装+Claude调用+流式处理
│       │   ├── system-prompt.ts      # System Prompt定义
│       │   ├── tools/                # Function Calling工具定义与实现
│       │   │   ├── index.ts          # 工具注册表
│       │   │   ├── query-tools.ts    # 查询类(get_player_state等)
│       │   │   ├── action-tools.ts   # 行动类(execute_battle_action等)
│       │   │   ├── generate-tools.ts # 生成类(generate_area等)
│       │   │   └── modify-tools.ts   # 修改类(modify_player_data等)
│       │   └── context-builder.ts    # 上下文组装(记忆管理)
│       ├── game/                     # 游戏引擎(纯算法，无AI)
│       │   ├── battle-engine.ts      # 战斗引擎(回合/伤害/结算)
│       │   ├── damage-calc.ts        # 伤害公式计算
│       │   ├── enemy-ai.ts           # 敌人AI决策(行为树)
│       │   ├── player-calc.ts        # 玩家属性计算
│       │   ├── drop-system.ts        # 掉落/奖励计算
│       │   └── formulas.ts           # 通用公式(经验/升级等)
│       ├── db/                       # 数据库
│       │   └── prisma.ts             # Prisma客户端单例
│       └── utils/                    # 工具函数
│
├── prisma/                           # Prisma ORM
│   ├── schema.prisma                 # 数据库Schema
│   ├── seed.ts                       # 种子数据
│   └── migrations/                   # 迁移文件
│
├── docs/                             # 设计文档
│   ├── GDD-完整游戏设计文档.md       # 主设计文档(本文件)
│   ├── development-plan.md           # 开发计划
│   └── systems/                      # 详细系统设计
│
└── public/                           # 静态资源
```

---

## 十四、开发路线图

> 📌 详细开发计划见 [development-plan.md](development-plan.md)

采用**迭代开发**方式，MVP 优先：

**MVP 阶段（核心体验验证）：**

| 子阶段 | 核心产出 |
|--------|----------|
| **A: 基础设施** | Next.js + Prisma + Supabase + 角色创建 |
| **B: AI Game Master** | Claude Function Calling + 15个工具 + SSE流式 + GM模式 |
| **C: 游戏引擎** | 战斗引擎 + 伤害计算 + 敌人AI + 掉落系统 |
| **D: 前端UI** | 聊天窗口 + 状态侧栏 + 快捷按钮 + 流式显示 |
| **E: 联调打磨** | 全流程测试 + 错误处理 + 体验优化 |

**后续迭代：**

| 迭代 | 核心内容 |
|------|----------|
| **迭代1** | 装备系统深度、技能系统、区域生成优化 |
| **迭代2** | NPC深度交互、任务系统丰富、奇遇事件 |
| **迭代3** | 境界突破、图鉴收集、成就系统 |
| **迭代4** | 用户认证、新手引导、部署上线 |

---

## 附录

### 玩家状态示例

| 类别 | 属性           | 示例值             |
| ---- | -------------- | ------------------ |
| 基础 | 名称           | 小女孩             |
| 基础 | 种族           | 人类               |
| 基础 | 背景           | 与海洋有着特殊联系 |
| 基础 | 境界           | 海洋级             |
| 战斗 | HP             | 1550 / 1550        |
| 战斗 | MP             | 2150 / 2150        |
| 装备 | 武器           | 骑鹅圈             |
| 装备 | 首饰           | 小水滴             |
| 装备 | 套装           | 光明套装           |
| 召唤 | 召唤兽         | 海兽（成长型）     |
| 环境 | 位置           | 海边小镇           |
| 环境 | 天气/时间/季节 | 晴 / 早晨 / 春     |

---

> 📝 **文档维护说明**
>
> - 本文档为 ChaosSaga 的核心设计蓝图
> - 开发过程中如有调整，请同步更新本文档
> - 详细技术实现请参考各模块的技术文档
