# ChaosSaga - 详细设计文档（落地版）

## 一、核心游戏循环

```
┌─────────────────────────────────────────────────────┐
│                   核心循环                           │
│                                                     │
│   冒险 → 战斗 → 获得奖励 → 变强 → 更难的冒险        │
│    ↑                                      │        │
│    └──────────────────────────────────────┘        │
└─────────────────────────────────────────────────────┘

详细闭环：
┌──────┐    ┌──────┐    ┌──────┐    ┌──────┐
│ 冒险  │ →  │ 战斗  │ →  │ 掉落  │ →  │ 成长  │
└──────┘    └──────┘    └──────┘    └──────┘
    ↑                                    │
    │    ┌──────┐    ┌──────┐           │
    │    │ 图鉴  │ ←  │ 收集  │ ←────────┤
    │    └──────┘    └──────┘           │
    │        │                          │
    │        ↓ (图鉴加成)                │
    │    ┌──────┐    ┌──────┐           │
    └────│ 强化  │ ←  │ 装备  │ ←────────┘
         └──────┘    └──────┘
```

---

## 二、回合制战斗系统

### 2.1 战斗流程

```
【战斗开始】
    │
    ▼
【回合开始】← ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐
    │                              │
    ▼                              │
【速度排序】决定行动顺序            │
    │                              │
    ▼                              │
【玩家回合】                        │
  ├─ 选择行动（攻击/技能/道具/防御/逃跑）
  ├─ 执行行动                      │
  └─ 结算伤害/效果                 │
    │                              │
    ▼                              │
【敌人回合】                        │
  ├─ AI选择行动                    │
  ├─ 执行行动                      │
  └─ 结算伤害/效果                 │
    │                              │
    ▼                              │
【回合结束】                        │
  ├─ 结算持续效果（中毒/灼烧等）   │
  ├─ 检查胜负条件                  │
  └─ 未结束 → ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘
    │
    ▼
【战斗结束】→ 结算奖励
```

### 2.2 战斗行动选项

| 行动 | 说明 | 消耗 |
|------|------|------|
| 普通攻击 | 基础物理伤害 | 无 |
| 技能 | 释放主动技能 | MP |
| 道具 | 使用消耗品 | 道具数量 |
| 防御 | 本回合减伤50% | 无 |
| 逃跑 | 尝试逃离战斗 | 无（有失败率）|

### 2.3 伤害计算公式

```python
# 基础伤害
base_damage = 攻击力 * 技能倍率

# 防御减伤
defense_reduction = 敌方防御 / (敌方防御 + 100)
after_defense = base_damage * (1 - defense_reduction)

# 暴击判定
if random() < 暴击率:
    after_crit = after_defense * 暴击伤害倍率
else:
    after_crit = after_defense

# 属性克制 (水克火、火克木、木克土、土克水)
element_bonus = 1.0  # 克制+30%, 被克-30%

# 最终伤害
final_damage = after_crit * element_bonus * (0.9 + random() * 0.2)
```

### 2.4 状态效果

| 效果 | 类型 | 说明 |
|------|------|------|
| 中毒 | 减益 | 每回合损失3%最大HP |
| 灼烧 | 减益 | 每回合损失5%最大HP |
| 冰冻 | 控制 | 跳过1回合行动 |
| 眩晕 | 控制 | 跳过1回合行动 |
| 减速 | 减益 | 速度降低30% |
| 护盾 | 增益 | 吸收一定伤害 |
| 再生 | 增益 | 每回合恢复5%最大HP |

---

## 三、数值系统

### 3.1 玩家属性公式

```python
# 基础属性 = 基础值 + 境界加成 + 装备加成 + 图鉴加成

# HP计算
max_hp = (100 + 等级 * 20) * 境界系数 + 装备HP + 图鉴HP

# MP计算
max_mp = (80 + 等级 * 15) * 境界系数 + 装备MP + 图鉴MP

# 攻击力
attack = (10 + 等级 * 5) * 境界系数 + 武器攻击 + 图鉴攻击

# 防御力
defense = (5 + 等级 * 3) * 境界系数 + 防具防御 + 图鉴防御

# 速度
speed = 50 + 等级 * 2 + 装备速度
```

### 3.2 境界系数表

| 境界 | 系数 | 等级范围 |
|------|------|----------|
| 海洋级 | 1.0 | 1-10 |
| 陆地级 | 2.0 | 11-20 |
| 荒芜级 | 4.0 | 21-30 |
| 行星级 | 8.0 | 31-40 |
| 恒星级 | 16.0 | 41-50 |
| 银河级 | 32.0 | 51-60 |
| 超越级 | 64.0 | 61-70 |
| 洪荒级 | 128.0 | 71-80 |
| 空灵级 | 256.0 | 81-90 |
| 元初级 | 512.0 | 91-100 |

### 3.3 经验与升级

```python
# 升级所需经验
exp_to_level = 100 * (当前等级 ^ 1.5)

# 战斗经验获取
battle_exp = 敌人基础经验 * (1 + 难度系数) * 经验加成

# 境界突破条件
突破条件 = {
    "等级达标": 当前等级 >= 境界等级上限,
    "突破材料": 拥有对应境界突破丹,
    "战斗次数": 当前境界战斗次数 >= 要求次数
}
```

---

## 四、经济系统

### 4.1 货币类型

| 货币 | 获取方式 | 用途 |
|------|----------|------|
| 金币 | 战斗掉落、任务、出售物品 | 商店购买、装备强化 |
| 灵石 | 副本奖励、成就、充值 | 高级道具、境界突破 |

### 4.2 物品产出与消耗

```
【产出】
战斗掉落 → 装备/材料/金币
副本奖励 → 稀有装备/灵石/技能书
图鉴奖励 → 特殊道具/称号
奇遇事件 → 随机奖励

【消耗】
装备强化 → 消耗金币+强化石
技能升级 → 消耗金币+技能点
境界突破 → 消耗灵石+突破丹
道具购买 → 消耗金币/灵石
```

---

## 五、技能详细设计

### 5.1 技能数据结构

| 字段 | 说明 |
|------|------|
| id | 技能唯一ID |
| name | 技能名称 |
| type | 类型(主动/场地/被动) |
| element | 属性(水/火/土/风/暗/光) |
| mp_cost | MP消耗 |
| cooldown | 冷却回合数 |
| damage_ratio | 伤害倍率 |
| effect | 附加效果 |
| target | 目标(单体/群体/自身) |

### 5.2 技能示例

| 技能名 | MP | CD | 倍率 | 效果 |
|--------|----|----|------|------|
| 梦幻冲击 | 30 | 2 | 1.5x | 30%眩晕1回合 |
| 投石术 | 20 | 0 | 1.2x | 无 |
| 冰箭术 | 25 | 1 | 1.3x | 减速2回合 |
| 地震术 | 50 | 3 | 1.0x | 群体攻击 |
| 暗影箭 | 35 | 2 | 1.8x | 无视30%防御 |
| 石化 | 60 | 4 | 0 | 石化2回合 |

---

## 六、副本系统

### 6.1 副本类型

| 类型 | 说明 | 刷新 |
|------|------|------|
| 随机冒险 | AI生成，基于环境 | 无限制 |
| BOSS战 | 单BOSS挑战 | 每日3次 |
| 剧情副本 | 主线故事 | 一次性 |
| 试炼塔 | 无限层数 | 每日重置进度 |

### 6.2 副本奖励结构

```
【随机冒险】
├── 经验: 基础 * 难度系数
├── 金币: 50-200
├── 掉落: 普通-稀有装备/材料
└── 图鉴: 可能发现新条目

【BOSS战】
├── 经验: 基础 * 3
├── 金币: 500-2000
├── 掉落: 稀有-传说装备
└── 首杀: 额外灵石奖励
```

---

## 七、AI生成系统

### 7.1 关卡生成Prompt

```
输入参数:
- 玩家境界、等级、属性
- 环境(位置、天气、时间、季节)
- 历史战斗记录

输出内容:
- 关卡名称和描述
- 敌人配置(类型、数量、属性)
- 战斗场景描述
- 可能的奇遇事件
```

### 7.2 战斗叙事生成

```
每回合AI生成战斗描述:
- 技能释放的视觉效果
- 伤害造成的反馈
- 角色状态变化
- 战场氛围渲染

示例输出:
"你挥动骑鹅圈，一道水蓝色的光芒划破空气！
 冰箭术命中深海蟹怪，造成 328 点伤害！
 蟹怪的动作明显变慢了...(减速2回合)"
```

---

## 八、数据库设计

### 8.1 核心表结构

```sql
-- 玩家表
players (
    id, telegram_id, name,
    level, realm, exp,
    hp, mp, current_hp, current_mp,
    attack, defense, speed,
    gold, spirit_stone,
    location, weather, time_of_day, season,
    created_at, last_active
)

-- 玩家技能表
player_skills (
    id, player_id, skill_id,
    level, proficiency
)

-- 玩家装备表
player_equipment (
    id, player_id, slot,
    item_id, item_data
)

-- 玩家背包表
player_inventory (
    id, player_id, item_id,
    quantity, item_data
)
```

---

## 九、API设计

### 9.1 核心API列表

| 接口 | 方法 | 说明 |
|------|------|------|
| /api/player | GET | 获取玩家信息 |
| /api/player | POST | 创建角色 |
| /api/battle/start | POST | 开始战斗 |
| /api/battle/action | POST | 执行战斗行动 |
| /api/inventory | GET | 获取背包 |
| /api/skills | GET | 获取技能列表 |
| /api/collection | GET | 获取图鉴 |

### 9.2 战斗API详细

```
POST /api/battle/start
请求: { type: "random" | "boss", environment: {...} }
响应: { battle_id, enemies[], scene_description }

POST /api/battle/action
请求: { battle_id, action: "attack" | "skill" | "item", target_id, skill_id? }
响应: {
    round_result,      // 本回合结果
    damage_dealt,      // 造成伤害
    narrative,         // AI生成的战斗描述
    battle_status,     // 战斗状态
    is_finished        // 是否结束
}
```

---

## 十、前端页面设计

### 10.1 页面列表

| 页面 | 路由 | 功能 |
|------|------|------|
| 登录页 | /login | 账号登录/注册 |
| 主界面 | /home | 角色状态总览 |
| 战斗页 | /battle | 回合制战斗 |
| 背包页 | /inventory | 物品管理 |
| 技能页 | /skills | 技能查看/升级 |
| 图鉴页 | /collection | 图鉴浏览 |

### 10.2 战斗页面布局

```
┌────────────────────────────────────┐
│         场景描述区域               │
├────────────────────────────────────┤
│  敌人状态: [名称] HP条 状态图标    │
├────────────────────────────────────┤
│         战斗叙事文本区             │
│   (AI生成的战斗描述滚动显示)       │
├────────────────────────────────────┤
│  玩家状态: HP条 MP条 状态图标      │
├────────────────────────────────────┤
│  [攻击] [技能] [道具] [防御]       │
└────────────────────────────────────┘
```

---

## 十一、开发路线图

### Phase 1: 核心框架 (1-2周)
- [ ] 后端项目搭建 (FastAPI)
- [ ] 数据库设计与连接
- [ ] 玩家创建与存储
- [ ] 基础属性系统

### Phase 2: 战斗系统 (2-3周)
- [ ] 回合制战斗逻辑
- [ ] 伤害计算系统
- [ ] 技能系统实现
- [ ] AI叙事生成集成

### Phase 3: 前端开发 (2-3周)
- [ ] React项目搭建
- [ ] 登录/注册页面
- [ ] 主界面开发
- [ ] 战斗页面开发

### Phase 4: 系统完善 (2周)
- [ ] 物品/装备系统
- [ ] 图鉴系统
- [ ] Telegram Bot集成
- [ ] 测试与优化

---

## 十二、区域故事背景系统

### 12.1 系统概述

```
玩家行动流程:
┌──────────┐     ┌──────────┐     ┌──────────┐
│ 选择区域  │ →   │ 生成背景  │ →   │ 开始冒险  │
└──────────┘     └──────────┘     └──────────┘
      │                                  │
      │  (未指定则沿用上次区域)           │
      └──────────────────────────────────┘
```

### 12.2 区域数据结构

| 字段 | 说明 |
|------|------|
| id | 区域唯一ID |
| name | 区域名称 |
| type | 类型(海域/陆地/城镇/秘境) |
| realm_requirement | 境界要求 |
| core_conflict | 核心矛盾 |
| player_goal | 玩家目标 |
| key_npcs | 关键NPC列表 |
| available_dungeons | 可用副本 |
| boss_list | BOSS列表 |
| lore | 背景故事 |

### 12.3 AI生成区域背景Prompt

```
输入参数:
- 区域名称和类型
- 玩家当前境界
- 玩家历史行为记录

输出内容:
1. 核心矛盾: 这个区域正在发生什么冲突？
2. 玩家目标: 玩家来到这里要做什么？
3. 关键NPC: 2-3个重要角色及其立场
4. 势力分布: 区域内的主要势力
5. 隐藏秘密: 可探索的隐藏内容
```

### 12.4 区域示例

**珊瑚海湾（海洋级区域）**

| 项目 | 内容 |
|------|------|
| 核心矛盾 | 渔民与海妖族的领地争端 |
| 玩家目标 | 调查失踪的渔船，揭开海妖的秘密 |
| 关键NPC | 老渔夫阿海(任务)、海妖公主(敌/友)、神秘商人(商店) |
| 可用副本 | 沉船遗迹、海妖巢穴 |
| BOSS | 深海蟹将、海妖女王 |

### 12.5 区域切换逻辑

```python
def start_adventure(player, area_id=None):
    # 如果未指定区域，沿用上次区域
    if area_id is None:
        area_id = player.current_area_id

    # 检查境界要求
    if not check_realm_requirement(player, area_id):
        return "境界不足，无法进入该区域"

    # 首次进入该区域，生成背景
    if not player.has_visited(area_id):
        background = ai_generate_area_background(area_id, player)
        save_area_background(player, area_id, background)

    # 更新玩家当前区域
    player.current_area_id = area_id
    return get_area_info(player, area_id)
```

### 12.6 区域相关API

| 接口 | 方法 | 说明 |
|------|------|------|
| /api/areas | GET | 获取可用区域列表 |
| /api/areas/{id} | GET | 获取区域详情 |
| /api/areas/{id}/enter | POST | 进入区域 |
| /api/areas/current | GET | 获取当前区域信息 |

### 12.7 数据库表

```sql
-- 区域表
areas (
    id, name, type,
    realm_requirement,
    base_description
)

-- 玩家区域记录表
player_areas (
    id, player_id, area_id,
    first_visit_at,
    generated_background,  -- AI生成的背景JSON
    progress,              -- 区域进度
    discovered_secrets     -- 已发现的秘密
)
```

---

## 十三、剧本文档系统

### 13.1 系统概述

```
玩家拥有两类长期保存的剧本文档:

┌─────────────────┐     ┌─────────────────┐
│  境界文档        │     │  区域文档        │
│  (永久保存)      │     │  (永久保存)      │
├─────────────────┤     ├─────────────────┤
│ - 突破条件       │     │ - 背景故事       │
│ - 境界特性       │     │ - 核心矛盾       │
│ - 修炼心得       │     │ - 关键NPC        │
│ - 重要事件       │     │ - 势力关系       │
└─────────────────┘     └─────────────────┘
```

### 13.2 境界文档结构

| 字段 | 说明 |
|------|------|
| realm_name | 境界名称 |
| breakthrough_conditions | 突破条件描述 |
| realm_features | 境界特性/能力 |
| cultivation_notes | 修炼心得 |
| important_events | 该境界经历的重要事件 |
| custom_content | 玩家自定义内容 |

### 13.4 文档存储规则

```
每个境界、每个区域独立一个文档，永久保存不覆盖

文档目录结构:
player_{id}/
├── realms/                    # 境界文档目录
│   ├── 01_海洋级.md
│   ├── 02_陆地级.md
│   ├── 03_荒芜级.md
│   └── ...
└── areas/                     # 区域文档目录
    ├── 珊瑚海湾.md
    ├── 迷雾森林.md
    └── ...
```
| created_at | 创建时间 |
| updated_at | 最后更新时间 |

### 13.3 区域文档结构

| 字段 | 说明 |
|------|------|
| area_name | 区域名称 |
| background_story | 背景故事 |
| core_conflict | 核心矛盾 |
| key_npcs | 关键NPC及描述 |
| faction_relations | 势力关系 |
| discovered_secrets | 已发现的秘密 |
| player_notes | 玩家笔记 |
| custom_content | 玩家自定义内容 |

### 13.4 文档存储规则

```
每个境界、每个区域独立一个文档，永久保存不覆盖

文档目录结构:
player_{id}/
├── realms/                    # 境界文档目录
│   ├── 01_海洋级.md
│   ├── 02_陆地级.md
│   ├── 03_荒芜级.md
│   └── ...
└── areas/                     # 区域文档目录
    ├── 珊瑚海湾.md
    ├── 迷雾森林.md
    └── ...
```
