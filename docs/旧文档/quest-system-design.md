# ChaosSaga - 任务与冒险系统设计

> 参考魔兽世界的任务链设计

---

## 一、区域类型与冒险模式

```
┌─────────────────────────────────────────────────────────────┐
│                    区域类型对照表                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌──────────────┐          ┌──────────────────────────┐   │
│   │  小型区域    │          │      大型区域             │   │
│   │  (遭遇战)    │          │    (任务驱动)            │   │
│   ├──────────────┤          ├──────────────────────────┤   │
│   │ • 野外怪物区 │          │ • 城镇                   │   │
│   │ • 小型洞穴   │          │ • 主线区域               │   │
│   │ • 路边遭遇   │          │ • 大型副本               │   │
│   │              │          │ • 势力领地               │   │
│   ├──────────────┤          ├──────────────────────────┤   │
│   │ 进入即战斗   │          │ 接任务 → 完成 → 推进     │   │
│   │ 随机敌人     │          │ 故事线驱动               │   │
│   │ 快速获取资源 │          │ 多任务并行               │   │
│   └──────────────┘          └──────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 二、大型区域：任务系统设计

### 2.1 任务类型

| 类型        | 说明                  | 玩法          | 示例                         |
| ----------- | --------------------- | ------------- | ---------------------------- |
| 🗡️ 击杀任务 | 消灭指定数量/类型敌人 | 战斗          | "击杀10只珊瑚蟹"             |
| 🎯 精英讨伐 | 击杀特定精英怪        | 高难度战斗    | "击败蟹将军"                 |
| 👑 BOSS挑战 | 区域BOSS战            | 剧情战斗      | "挑战海妖女王"               |
| 🔍 收集任务 | 收集指定物品          | 探索/战斗掉落 | "收集5个珍珠"                |
| 🧩 解谜任务 | 解开谜题机关          | 选择/推理     | "破解海底石碑的密文"         |
| 🚶 护送任务 | 护送NPC到达目的地     | 连续战斗      | "护送老渔夫回村"             |
| 💬 对话任务 | 与NPC交流获取信息     | 剧情推进      | "询问神秘商人关于沉船的线索" |
| 🔎 调查任务 | 调查特定地点/事件     | 探索发现      | "调查失踪渔船的最后位置"     |
| ⏰ 限时任务 | 限时完成目标          | 紧迫感        | "在涨潮前救出被困渔民"       |

### 2.2 任务链结构

```
                        【主线任务链】
                             │
     ┌───────────────────────┼───────────────────────┐
     │                       │                       │
     ▼                       ▼                       ▼
┌─────────┐           ┌─────────┐           ┌─────────┐
│ 第一章  │ ────────→ │ 第二章  │ ────────→ │ 第三章  │
│ 调查篇  │           │ 冲突篇  │           │ 决战篇  │
└────┬────┘           └────┬────┘           └────┬────┘
     │                     │                     │
     ▼                     ▼                     ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ 1-1 与老渔夫对话 │ │ 2-1 拯救被困渔民 │ │ 3-1 突入海妖巢穴 │
│ 1-2 调查沉船     │ │ 2-2 击退海妖小队 │ │ 3-2 击败海妖女王 │
│ 1-3 收集线索     │ │ 2-3 保护珍珠矿脉 │ │ 3-3 抉择时刻     │
│ 1-4 破解密文     │ │ 2-4 对话海妖公主 │ │                 │
└─────────────────┘ └─────────────────┘ └─────────────────┘
         │                   │                   │
         └───────────────────┼───────────────────┘
                             │
                      【支线任务】(可选)
                             │
         ┌───────────────────┼───────────────────┐
         │                   │                   │
         ▼                   ▼                   ▼
   ┌───────────┐      ┌───────────┐      ┌───────────┐
   │ 日常悬赏  │      │ 声望任务  │      │ 隐藏任务  │
   │ (可重复)  │      │ (解锁商店)│      │ (探索触发)│
   └───────────┘      └───────────┘      └───────────┘
```

### 2.3 任务状态机

```
┌─────────┐   接受    ┌─────────┐   完成目标   ┌─────────┐
│  可接取  │ ────────→ │ 进行中  │ ───────────→ │ 可交付  │
└─────────┘           └─────────┘              └────┬────┘
     ↑                      │                       │
     │                      │ 放弃                  │ 交付
     │                      ▼                       ▼
     │               ┌─────────┐             ┌─────────┐
     └───────────────│  重置   │             │  已完成  │
                     └─────────┘             └─────────┘
```

---

## 三、珊瑚海湾任务链示例（完整）

### 3.1 区域信息

| 属性     | 值                      |
| -------- | ----------------------- |
| 区域名称 | 珊瑚海湾                |
| 区域类型 | 大型区域 (任务驱动)     |
| 推荐等级 | Lv.1-10 (海洋级)        |
| 核心矛盾 | 渔民与海妖族的领地争端  |
| 结局类型 | 多结局 (和平/战争/隐藏) |

### 3.2 主线任务链

#### 第一章：迷雾之谜

| 任务ID | 任务名     | 类型    | 目标                 | 前置 | 奖励             |
| ------ | ---------- | ------- | -------------------- | ---- | ---------------- |
| Q101   | 渔村的烦恼 | 💬 对话 | 与老渔夫阿海对话     | 无   | 经验×50          |
| Q102   | 失踪的渔船 | 🔎 调查 | 调查海湾3处沉船位置  | Q101 | 经验×80, 金币×30 |
| Q103   | 蟹群来袭   | 🗡️ 击杀 | 击杀10只珊瑚蟹       | Q102 | 经验×100, 蟹壳×5 |
| Q104   | 海底密文   | 🧩 解谜 | 破解珊瑚石碑上的文字 | Q103 | 经验×120, 技能书 |
| Q105   | 线索汇总   | 💬 对话 | 向阿海汇报发现       | Q104 | 解锁第二章       |

#### 第二章：暗流涌动

| 任务ID | 任务名       | 类型    | 目标                   | 前置 | 奖励               |
| ------ | ------------ | ------- | ---------------------- | ---- | ------------------ |
| Q201   | 紧急救援     | 🚶 护送 | 救出被困渔民并护送回村 | Q105 | 经验×150, 金币×80  |
| Q202   | 海妖的踪迹   | 🔎 调查 | 追踪海妖活动痕迹       | Q201 | 经验×100, 图鉴更新 |
| Q203   | 前哨战       | 🎯 精英 | 击败海妖斥候队长       | Q202 | 经验×200, 稀有装备 |
| Q204   | 珍珠矿的秘密 | 🔍 收集 | 收集3块特殊珍珠        | Q203 | 经验×150           |
| Q205   | 意外的访客   | 💬 对话 | 遭遇海妖公主珊珊       | Q204 | 解锁分支           |

#### 第三章：抉择之时 (多分支)

**分支A：和平路线** (与海妖公主合作)

| 任务ID | 任务名     | 类型    | 目标                 |
| ------ | ---------- | ------- | -------------------- |
| Q301A  | 信任的证明 | 🔍 收集 | 帮助海妖收集治愈草药 |
| Q302A  | 真相大白   | 🔎 调查 | 发现真正的幕后黑手   |
| Q303A  | 联手出击   | 👑 BOSS | 击败【深渊使者】     |

**分支B：战争路线** (站在渔民一方)

| 任务ID | 任务名   | 类型    | 目标                |
| ------ | -------- | ------- | ------------------- |
| Q301B  | 备战     | 🔍 收集 | 收集武器材料        |
| Q302B  | 突袭     | 🗡️ 击杀 | 消灭海妖巢穴守卫×20 |
| Q303B  | 王座之战 | 👑 BOSS | 击败【海妖女王】    |

### 3.3 支线任务

| 任务ID | 任务名             | 类型    | 触发条件       | 特点     |
| ------ | ------------------ | ------- | -------------- | -------- |
| S01    | 渔夫的遗物         | 🔍 收集 | Q102后触发     | 隐藏奖励 |
| S02    | 神秘商人的请求     | 🔍 收集 | 与商人对话     | 解锁商店 |
| S03    | 深海的呼唤         | 🧩 解谜 | 夜间在特定位置 | 隐藏技能 |
| D01    | 每日悬赏：清理蟹群 | 🗡️ 击杀 | 每日可接       | 可重复   |
| D02    | 每日悬赏：珍珠采集 | 🔍 收集 | 每日可接       | 可重复   |

---

## 四、任务交互流程

### 4.1 接取任务

```
玩家                  前端                  后端                  Claude API
 │                     │                     │                       │
 │── 与NPC对话 ───────→│                     │                       │
 │                     │                     │                       │
 │                     │── GET /api/npc/{id}/quests ─→│              │
 │                     │                     │                       │
 │                     │                     │   查询可接任务        │
 │                     │                     │   检查前置条件        │
 │                     │                     │                       │
 │                     │←── 返回可接任务列表 ─│                       │
 │                     │                     │                       │
 │←─ 显示任务列表 ─────│                     │                       │
 │   [接受] [拒绝]     │                     │                       │
 │                     │                     │                       │
 │── 点击"接受" ──────→│                     │                       │
 │                     │                     │                       │
 │                     │── POST /api/quests/accept ──→│              │
 │                     │   {questId: "Q101"}          │              │
 │                     │                     │                       │
 │                     │                     │   ┌────────────────┐  │
 │                     │                     │   │ 创建任务进度   │  │
 │                     │                     │   │ 发放追踪物品   │  │
 │                     │                     │   └────────────────┘  │
 │                     │                     │                       │
 │                     │                     │─── 生成任务对话 ─────→│
 │                     │                     │                       │
 │                     │                     │←── NPC台词 ──────────│
 │                     │                     │                       │
 │                     │←── 任务接取成功 ────│                       │
 │                     │    + NPC对话内容    │                       │
 │                     │                     │                       │
 │←─ 显示任务接取动画 ─│                     │                       │
 │   NPC: "年轻人..."  │                     │                       │
 │   任务追踪更新      │                     │                       │
```

### 4.2 任务进行中：击杀任务

```
玩家                  前端                  后端
 │                     │                     │
 │── 在区域内探索 ────→│                     │
 │                     │                     │
 │── 遭遇珊瑚蟹 ──────→│                     │
 │                     │── POST /api/battle/start ──→│
 │                     │                     │
 │      (战斗流程...)  │                     │
 │                     │                     │
 │── 击杀珊瑚蟹 ──────→│                     │
 │                     │                     │
 │                     │←── 战斗结算 ────────│
 │                     │    + 任务进度更新   │
 │                     │    {                │
 │                     │      quest: "Q103", │
 │                     │      progress: "3/10"│
 │                     │    }                │
 │                     │                     │
 │←─ 显示进度更新 ─────│                     │
 │   "珊瑚蟹 3/10"     │                     │
 │                     │                     │
 │      (继续击杀...)  │                     │
 │                     │                     │
 │←─ 任务完成提示 ─────│                     │
 │   "任务目标已完成"  │                     │
 │   "返回找老渔夫"    │                     │
```

### 4.3 任务进行中：解谜任务

```
玩家                  前端                  后端                  Claude API
 │                     │                     │                       │
 │── 到达石碑位置 ────→│                     │                       │
 │                     │                     │                       │
 │── 点击"调查石碑" ──→│                     │                       │
 │                     │                     │                       │
 │                     │── POST /api/puzzle/start ──→│               │
 │                     │   {puzzleId: "coral_tablet"} │               │
 │                     │                     │                       │
 │                     │                     │─── 生成谜题内容 ─────→│
 │                     │                     │                       │
 │                     │                     │←── 谜题描述+选项 ────│
 │                     │                     │                       │
 │                     │←── 返回谜题 ────────│                       │
 │                     │                     │                       │
 │←─ 显示解谜界面 ─────│                     │                       │
 │   "古老的石碑上刻   │                     │                       │
 │    着神秘的符文..." │                     │                       │
 │                     │                     │                       │
 │   [A] 按日月顺序    │                     │                       │
 │   [B] 按潮汐规律    │                     │                       │
 │   [C] 按海洋生物    │                     │                       │
 │                     │                     │                       │
 │── 选择答案 [B] ────→│                     │                       │
 │                     │                     │                       │
 │                     │── POST /api/puzzle/answer ──→│              │
 │                     │   {answer: "B"}              │              │
 │                     │                     │                       │
 │                     │                     │   判定正确!           │
 │                     │                     │   更新任务进度        │
 │                     │                     │                       │
 │                     │                     │─── 生成解谜叙事 ─────→│
 │                     │                     │                       │
 │                     │                     │←── 解谜结果描述 ─────│
 │                     │                     │                       │
 │                     │←── 解谜成功 ────────│                       │
 │                     │                     │                       │
 │←─ 播放解谜动画 ─────│                     │                       │
 │   "你发现了潮汐的   │                     │                       │
 │    规律！石碑缓缓   │                     │                       │
 │    打开，露出..."   │                     │                       │
```

### 4.4 任务交付

```
玩家                  前端                  后端                  Claude API
 │                     │                     │                       │
 │── 返回找NPC ───────→│                     │                       │
 │                     │                     │                       │
 │                     │── GET /api/npc/{id} ────────→│              │
 │                     │                     │                       │
 │                     │                     │   检查可交付任务      │
 │                     │                     │                       │
 │                     │←── NPC状态 ─────────│                       │
 │                     │    hasCompletedQuest: true   │              │
 │                     │                     │                       │
 │←─ NPC头上显示"?" ──│                     │                       │
 │                     │                     │                       │
 │── 与NPC对话 ───────→│                     │                       │
 │                     │                     │                       │
 │                     │── POST /api/quests/complete ─→│             │
 │                     │   {questId: "Q103"}          │             │
 │                     │                     │                       │
 │                     │                     │   ┌────────────────┐  │
 │                     │                     │   │ 发放奖励       │  │
 │                     │                     │   │ 解锁后续任务   │  │
 │                     │                     │   │ 更新图鉴       │  │
 │                     │                     │   └────────────────┘  │
 │                     │                     │                       │
 │                     │                     │─── 生成完成对话 ─────→│
 │                     │                     │                       │
 │                     │                     │←── NPC感谢台词 ──────│
 │                     │                     │                       │
 │                     │←── 任务完成 ────────│                       │
 │                     │                     │                       │
 │←─ 显示奖励界面 ─────│                     │                       │
 │   经验+100          │                     │                       │
 │   蟹壳×5            │                     │                       │
 │   NPC: "干得好!"    │                     │                       │
 │                     │                     │                       │
 │←─ 新任务可接提示 ──│                     │                       │
```

---

## 五、小型区域：遭遇战系统

### 5.1 遭遇战触发

```
┌─────────────────────────────────────────────────────────────┐
│                    小型区域遭遇战流程                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   玩家进入小型区域                                          │
│         │                                                   │
│         ▼                                                   │
│   ┌─────────────┐                                          │
│   │ 遭遇判定    │                                          │
│   │ 概率: 80%  │                                          │
│   └──────┬──────┘                                          │
│          │                                                  │
│     ┌────┴────┐                                            │
│     │         │                                            │
│     ▼         ▼                                            │
│  触发遭遇   安全通过                                        │
│     │         │                                            │
│     ▼         ▼                                            │
│  随机敌人   可选探索                                        │
│  立即战斗   或离开                                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 小型区域列表

| 区域名     | 类型   | 敌人池         | 掉落特点 |
| ---------- | ------ | -------------- | -------- |
| 珊瑚礁外围 | 遭遇战 | 珊瑚蟹、小海妖 | 普通材料 |
| 沉船残骸   | 遭遇战 | 海蛇、幽灵水手 | 装备碎片 |
| 海藻林     | 遭遇战 | 海藻怪、毒水母 | 药剂材料 |
| 礁石隧道   | 遭遇战 | 穴居蟹、盲鳗   | 矿石     |

---

## 六、数据库设计补充

### 6.1 新增：任务表 (Quest)

| 字段            | 类型     | 说明                                                       |
| --------------- | -------- | ---------------------------------------------------------- |
| id              | String   | 任务ID                                                     |
| name            | String   | 任务名称                                                   |
| type            | Enum     | kill/elite/boss/collect/puzzle/escort/dialogue/investigate |
| areaId          | String   | 所属区域                                                   |
| chainId         | String?  | 任务链ID                                                   |
| chainOrder      | Int?     | 链中顺序                                                   |
| prerequisiteIds | String[] | 前置任务                                                   |
| **目标配置**    |          |                                                            |
| targetType      | String   | 目标类型 (enemy/item/location/npc)                         |
| targetId        | String   | 目标ID                                                     |
| targetCount     | Int      | 目标数量                                                   |
| **奖励配置**    |          |                                                            |
| expReward       | Int      | 经验奖励                                                   |
| goldReward      | Int      | 金币奖励                                                   |
| itemRewards     | Json     | 物品奖励                                                   |
| **NPC关联**     |          |                                                            |
| giverNpcId      | String   | 任务发放NPC                                                |
| turnInNpcId     | String   | 任务交付NPC                                                |
| **元信息**      |          |                                                            |
| isDaily         | Boolean  | 是否日常任务                                               |
| isHidden        | Boolean  | 是否隐藏任务                                               |
| description     | String   | 任务描述                                                   |

### 6.2 新增：玩家任务进度表 (PlayerQuest)

| 字段         | 类型      | 说明                                          |
| ------------ | --------- | --------------------------------------------- |
| id           | String    | 主键                                          |
| playerId     | String    | 玩家ID                                        |
| questId      | String    | 任务ID                                        |
| status       | Enum      | available/active/completable/completed/failed |
| progress     | Int       | 当前进度                                      |
| targetCount  | Int       | 目标数量                                      |
| acceptedAt   | DateTime  | 接取时间                                      |
| completedAt  | DateTime? | 完成时间                                      |
| dailyResetAt | DateTime? | 日常重置时间                                  |

### 6.3 新增：谜题表 (Puzzle)

| 字段          | 类型     | 说明                           |
| ------------- | -------- | ------------------------------ |
| id            | String   | 谜题ID                         |
| questId       | String   | 关联任务                       |
| type          | Enum     | choice/sequence/cipher/pattern |
| prompt        | String   | 谜题描述 (可含AI模板)          |
| options       | Json     | 选项列表                       |
| correctAnswer | String   | 正确答案                       |
| hints         | String[] | 提示列表                       |
| failPenalty   | Json?    | 失败惩罚                       |

---

## 七、AI Prompt：任务对话生成

```
【系统角色】
你是ChaosSaga的NPC对话编剧，负责生成任务相关的NPC台词。

【NPC信息】
名称: 老渔夫阿海
性格: 和蔼、忧心忡忡、有些唠叨
身份: 渔村长老

【任务信息】
任务: Q103 蟹群来袭
类型: 击杀任务
目标: 击杀10只珊瑚蟹
上下文: 玩家刚调查完沉船，发现蟹群异常活跃

【场景】
任务发放对话

【要求】
1. 符合NPC性格
2. 自然引出任务目标
3. 体现紧迫感
4. 100字左右

【输出格式】
{
  "greeting": "见面问候",
  "questIntro": "任务介绍",
  "questAccept": "玩家接受后的话",
  "questDecline": "玩家拒绝后的话"
}
```

---

## 八、更新：区域数据结构

```json
{
  "id": "coral_bay",
  "name": "珊瑚海湾",
  "type": "major", // major=大型区域, minor=小型区域
  "realmRequirement": "ocean",
  "subAreas": [
    {
      "id": "coral_village",
      "name": "珊瑚渔村",
      "type": "town",
      "npcs": ["elder_ahai", "merchant", "quest_board"]
    },
    {
      "id": "coral_reef_outer",
      "name": "珊瑚礁外围",
      "type": "encounter", // 遭遇战区域
      "enemyPool": ["coral_crab", "small_mermaid"],
      "encounterRate": 0.8
    },
    {
      "id": "shipwreck_area",
      "name": "沉船区域",
      "type": "quest", // 任务区域
      "relatedQuests": ["Q102", "S01"]
    },
    {
      "id": "mermaid_lair",
      "name": "海妖巢穴",
      "type": "dungeon",
      "unlockQuest": "Q301B", // 需完成特定任务解锁
      "boss": "mermaid_queen"
    }
  ],
  "mainQuestChain": "coral_bay_main",
  "sideQuests": ["S01", "S02", "S03"],
  "dailyQuests": ["D01", "D02"]
}
```

---

> 📝 本文档扩展了任务系统设计，支持魔兽世界风格的任务链和多样化任务类型。
