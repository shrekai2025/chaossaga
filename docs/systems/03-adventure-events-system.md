# ChaosSaga - å¥‡é‡äº‹ä»¶ç³»ç»Ÿè¯¦ç»†è®¾è®¡

> ç‰ˆæœ¬: 1.0 | æ›´æ–°æ—¥æœŸ: 2026-02-08
> å¯¹åº” GDD ç« èŠ‚: ä¹ã€AIå‰§æœ¬åˆ›ä½œç³»ç»Ÿ (å¥‡é‡å­ç³»ç»Ÿ)

---

## ä¸€ã€ç³»ç»Ÿæ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¥‡é‡äº‹ä»¶ç³»ç»Ÿæ¶æ„                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ è§¦å‘åˆ¤å®š  â”‚ â†’  â”‚ äº‹ä»¶ç­‰çº§æŠ½å–  â”‚ â†’  â”‚ äº‹ä»¶æ± ç­›é€‰ä¸æŠ½å–     â”‚  â”‚
â”‚  â”‚(æ¦‚ç‡è®¡ç®—) â”‚    â”‚(åŠ æƒéšæœº)    â”‚    â”‚(æ¡ä»¶åŒ¹é…+AIç”Ÿæˆ)    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚              â”‚
â”‚                                                  â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç»“ç®—å¥–æƒ©  â”‚ â†  â”‚ ç©å®¶åšå‡ºé€‰æ‹©  â”‚ â†  â”‚ å±•ç¤ºäº‹ä»¶ä¸é€‰é¡¹       â”‚  â”‚
â”‚  â”‚(æ•°å€¼è®¡ç®—) â”‚    â”‚              â”‚    â”‚                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚       â”‚                                                        â”‚
â”‚       â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  è®°å½•åˆ°å¥‡é‡æ—¥å¿— / æ›´æ–°å›¾é‰´ / è§¦å‘åç»­é“¾å¼äº‹ä»¶            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¾è®¡åŸåˆ™:
- è§¦å‘åˆ¤å®šã€ç­‰çº§æŠ½å–ã€å¥–åŠ±ç»“ç®— = ä¼ ç»Ÿæ•°å€¼è®¡ç®—ï¼ˆæœ¬åœ°ç®—æ³•ï¼‰
- äº‹ä»¶å‰§æƒ…æ–‡æœ¬ = AIç”Ÿæˆï¼ˆä»…å™äº‹å±‚ï¼‰æˆ–é¢„åˆ¶æ¨¡æ¿
- é€‰é¡¹ç»“æœ = é¢„å®šä¹‰æ•°å€¼ + AIå™äº‹åŒ…è£…
```

---

## äºŒã€è§¦å‘ç³»ç»Ÿ

### 2.1 è§¦å‘æ—¶æœº

| è§¦å‘æ—¶æœº | åˆ¤å®šé¢‘ç‡ | è¯´æ˜ |
|----------|----------|------|
| æˆ˜æ–—èƒœåˆ©å | æ¯æ¬¡æˆ˜æ–—ç»“ç®—æ—¶ | æœ€å¸¸è§çš„è§¦å‘ç‚¹ |
| è¿›å…¥æ–°åŒºåŸŸ | é¦–æ¬¡è¿›å…¥æ—¶ | åŒºåŸŸä¸“å±å¥‡é‡ |
| åŒºåŸŸæ¢ç´¢ä¸­ | æ¯æ¬¡"æ¢ç´¢"æ“ä½œ | éæˆ˜æ–—æ¢ç´¢è¡Œä¸º |
| ç‰¹å®šæ—¶é—´ | æ£€æŸ¥ç¯å¢ƒæ—¶é—´ | å¤œé—´/é»æ˜ç‰¹æ®Šäº‹ä»¶ |
| å¢ƒç•Œçªç ´å | çªç ´å®Œæˆæ—¶ | å¢ƒç•Œç›¸å…³å¥‡é‡ |
| NPCäº¤äº’å | å¯¹è¯å®Œæˆæ—¶ | ç¤¾äº¤è§¦å‘çš„å¥‡é‡ |

### 2.2 åŸºç¡€è§¦å‘æ¦‚ç‡

```typescript
// lib/game/adventure-trigger.ts

interface TriggerContext {
  player: {
    level: number;
    realm: string;
    background: string;
    luck: number;           // å¹¸è¿å€¼ï¼ˆæ¥è‡ªè£…å¤‡/ç§°å·/å›¾é‰´åŠ æˆï¼‰
    currentAreaId: string;
    currentHpPercent: number;
  };
  environment: {
    weather: string;
    timeOfDay: string;
    season: string;
  };
  history: {
    lastAdventureRound: number;   // è·ä¸Šæ¬¡å¥‡é‡çš„æˆ˜æ–—åœºæ¬¡
    totalAdventures: number;      // æ€»å¥‡é‡æ¬¡æ•°
    todayAdventures: number;      // ä»Šæ—¥å¥‡é‡æ¬¡æ•°
  };
  triggerSource: 'battle_end' | 'area_enter' | 'explore' | 'time' | 'breakthrough' | 'npc';
}

/** åŸºç¡€è§¦å‘æ¦‚ç‡ */
const BASE_TRIGGER_RATES: Record<string, number> = {
  battle_end: 0.15,     // 15% æˆ˜æ–—åè§¦å‘
  area_enter: 0.30,     // 30% è¿›å…¥æ–°åŒºåŸŸè§¦å‘
  explore: 0.25,        // 25% æ¢ç´¢è¡Œä¸ºè§¦å‘
  time: 0.10,           // 10% æ—¶é—´äº‹ä»¶
  breakthrough: 0.80,   // 80% å¢ƒç•Œçªç ´åè§¦å‘
  npc: 0.08,            // 8% NPCäº¤äº’åè§¦å‘
};

/**
 * è®¡ç®—å®é™…è§¦å‘æ¦‚ç‡
 * æ¦‚ç‡ = åŸºç¡€æ¦‚ç‡ Ã— ä¿åº•åŠ æˆ Ã— èƒŒæ™¯åŠ æˆ Ã— ç¯å¢ƒåŠ æˆ Ã— å¹¸è¿åŠ æˆ Ã— å†·å´æƒ©ç½š
 */
function calculateTriggerChance(ctx: TriggerContext): number {
  let chance = BASE_TRIGGER_RATES[ctx.triggerSource] ?? 0.10;

  // ä¿åº•æœºåˆ¶ï¼šè·ä¸Šæ¬¡å¥‡é‡è¶Šä¹…ï¼Œæ¦‚ç‡è¶Šé«˜
  // æ¯å¤šæ‰“3åœºæˆ˜æ–—ï¼Œæ¦‚ç‡+5%ï¼Œæœ€å¤š+30%
  const pityBonus = Math.min(
    Math.floor(ctx.history.lastAdventureRound / 3) * 0.05,
    0.30
  );
  chance += pityBonus;

  // èƒŒæ™¯åŠ æˆï¼šæµ·æ´‹ä¹‹å­åœ¨æµ·åŸŸåŒºåŸŸ+15%
  if (ctx.player.background === 'æµ·æ´‹ä¹‹å­' && isOceanArea(ctx.player.currentAreaId)) {
    chance *= 1.15;
  }

  // ç¯å¢ƒåŠ æˆ
  chance *= getEnvironmentBonus(ctx.environment);

  // å¹¸è¿å€¼åŠ æˆï¼šæ¯10ç‚¹å¹¸è¿+1%
  chance *= (1 + ctx.player.luck * 0.001);

  // æ¯æ—¥å†·å´ï¼šä»Šæ—¥å·²è§¦å‘è¶…è¿‡5æ¬¡åæ¦‚ç‡å‡åŠ
  if (ctx.history.todayAdventures >= 5) {
    chance *= 0.5;
  }
  if (ctx.history.todayAdventures >= 10) {
    chance *= 0.3; // ç´¯ç§¯
  }

  // æ¦‚ç‡ä¸Šé™80%ï¼ˆæ°¸è¿œæœ‰ä¸è§¦å‘çš„å¯èƒ½ï¼‰
  return Math.min(chance, 0.80);
}

/** ç¯å¢ƒå¯¹å¥‡é‡æ¦‚ç‡çš„åŠ æˆ */
function getEnvironmentBonus(env: { weather: string; timeOfDay: string; season: string }): number {
  let bonus = 1.0;

  // ç‰¹æ®Šå¤©æ°”å¢åŠ å¥‡é‡æ¦‚ç‡
  const weatherBonuses: Record<string, number> = {
    'è¿·é›¾': 1.3,
    'é›·æš´': 1.2,
    'æš´é£é›¨': 1.2,
    'å¤§é›ª': 1.15,
    'æ™´': 1.0,
    'é›¨': 1.05,
    'é›ª': 1.1,
  };
  bonus *= weatherBonuses[env.weather] ?? 1.0;

  // æ·±å¤œå’Œé»æ˜å¥‡é‡æ¦‚ç‡æ›´é«˜
  const timeBonuses: Record<string, number> = {
    'æ·±å¤œ': 1.25,
    'é»æ˜': 1.2,
    'å‚æ™š': 1.1,
    'æ—©æ™¨': 1.0,
    'ä¸­åˆ': 0.95,
  };
  bonus *= timeBonuses[env.timeOfDay] ?? 1.0;

  return bonus;
}
```

### 2.3 è§¦å‘æµç¨‹

```typescript
/**
 * å¥‡é‡è§¦å‘å…¥å£
 * è¿”å›nullè¡¨ç¤ºæœªè§¦å‘
 */
function tryTriggerAdventure(ctx: TriggerContext): AdventureEvent | null {
  // 1. è®¡ç®—è§¦å‘æ¦‚ç‡
  const chance = calculateTriggerChance(ctx);
  
  // 2. éšæœºåˆ¤å®š
  if (Math.random() > chance) {
    return null; // æœªè§¦å‘
  }

  // 3. æŠ½å–äº‹ä»¶ç­‰çº§
  const tier = rollEventTier(ctx);

  // 4. ä»äº‹ä»¶æ± ç­›é€‰å¹¶æŠ½å–
  const event = selectEvent(ctx, tier);

  return event;
}
```

---

## ä¸‰ã€äº‹ä»¶ç­‰çº§ç³»ç»Ÿ

### 3.1 å››ä¸ªäº‹ä»¶ç­‰çº§

| ç­‰çº§ | é¢œè‰² | æ¦‚ç‡æƒé‡ | å¥–åŠ±å€ç‡ | é£é™©ç¨‹åº¦ | é€‰é¡¹æ•° |
|------|------|----------|----------|----------|--------|
| æ™®é€š (Common) | ç™½è‰² | 55% | 1.0x | ä½ | 2 |
| ç¨€æœ‰ (Rare) | è“è‰² | 30% | 2.0x | ä¸­ | 2-3 |
| å²è¯— (Epic) | ç´«è‰² | 12% | 4.0x | é«˜ | 3 |
| ä¼ è¯´ (Legendary) | æ©™è‰² | 3% | 8.0x | æé«˜ | 3 |

### 3.2 ç­‰çº§æŠ½å–ç®—æ³•

```typescript
interface EventTierConfig {
  tier: 'common' | 'rare' | 'epic' | 'legendary';
  baseWeight: number;
}

const TIER_WEIGHTS: EventTierConfig[] = [
  { tier: 'common',    baseWeight: 55 },
  { tier: 'rare',      baseWeight: 30 },
  { tier: 'epic',      baseWeight: 12 },
  { tier: 'legendary', baseWeight: 3  },
];

/**
 * æŠ½å–äº‹ä»¶ç­‰çº§
 * å—ç©å®¶ç­‰çº§å’Œå¹¸è¿å€¼å½±å“
 */
function rollEventTier(ctx: TriggerContext): string {
  const weights = TIER_WEIGHTS.map(t => {
    let w = t.baseWeight;

    // é«˜ç­‰çº§ç©å®¶ç¨€æœ‰äº‹ä»¶æ¦‚ç‡ç•¥å¢
    if (ctx.player.level > 30 && t.tier !== 'common') {
      w *= 1.1;
    }
    if (ctx.player.level > 60 && t.tier === 'legendary') {
      w *= 1.2;
    }

    // å¹¸è¿å€¼åŠ æˆï¼ˆä¸»è¦å½±å“ç¨€æœ‰ä»¥ä¸Šï¼‰
    if (t.tier !== 'common') {
      w *= (1 + ctx.player.luck * 0.002);
    }

    return { tier: t.tier, weight: w };
  });

  // åŠ æƒéšæœº
  const total = weights.reduce((sum, w) => sum + w.weight, 0);
  let roll = Math.random() * total;
  for (const w of weights) {
    roll -= w.weight;
    if (roll <= 0) return w.tier;
  }
  return 'common';
}
```

---

## å››ã€äº‹ä»¶æ± è®¾è®¡

### 4.1 äº‹ä»¶åˆ†ç±»

| ç±»åˆ« | ä»£ç  | è¯´æ˜ | å…¸å‹åœºæ™¯ |
|------|------|------|----------|
| æ¢ç´¢å‘ç° | exploration | å‘ç°éšè—åœ°ç‚¹/ç‰©å“ | å‘ç°å¤è€å®ç®±ã€éšç§˜æ´ç©´ |
| æˆ˜æ–—é­é‡ | combat | ç‰¹æ®Šæˆ˜æ–—äº‹ä»¶ | ç²¾è‹±æ€ªä¼å‡»ã€æµæµªæ­¦è€…æŒ‘æˆ˜ |
| ç¤¾äº¤é™…é‡ | social | é‡åˆ°NPC/æ—…è€… | è¿·è·¯çš„æ—…äººã€ç¥ç§˜å•†äºº |
| è°œé¢˜æœºå…³ | mystery | è§£è°œ/æŠ‰æ‹©äº‹ä»¶ | å¤è€çŸ³ç¢‘ã€ç¥ç§˜ç¥­å› |
| å‘½è¿è½¬æŠ˜ | fortune | è¿æ°”/èµŒåšç±»äº‹ä»¶ | è®¸æ„¿æ± ã€å‘½è¿è½¬ç›˜ |
| ç¯å¢ƒå¼‚å˜ | environment | ç¯å¢ƒå¼•å‘çš„ç‰¹æ®Šäº‹ä»¶ | çªå¦‚å…¶æ¥çš„æš´é£é›¨ã€åœ°éœ‡ |
| èƒŒæ™¯ä¸“å± | background | ä¸ç©å®¶èƒŒæ™¯å…³è” | æµ·æ´‹ä¹‹å­å¬åˆ°æµ·å…½å‘¼å”¤ |

### 4.2 é¢„åˆ¶äº‹ä»¶æ¨¡æ¿ï¼ˆæœ¬åœ°äº‹ä»¶æ± ï¼‰

```typescript
// lib/game/adventure-events-pool.ts

interface PresetEvent {
  id: string;
  name: string;
  category: string;
  tier: 'common' | 'rare' | 'epic' | 'legendary';
  
  /** è§¦å‘æ¡ä»¶ */
  conditions: {
    realmMin?: string;          // æœ€ä½å¢ƒç•Œ
    realmMax?: string;          // æœ€é«˜å¢ƒç•Œ
    areaTypes?: string[];       // é™å®šåŒºåŸŸç±»å‹
    weather?: string[];         // é™å®šå¤©æ°”
    timeOfDay?: string[];       // é™å®šæ—¶é—´
    season?: string[];          // é™å®šå­£èŠ‚
    background?: string[];      // é™å®šèƒŒæ™¯
    requireQuestComplete?: string; // éœ€å®ŒæˆæŸä»»åŠ¡
  };

  /** äº‹ä»¶æè¿°ï¼ˆæ”¯æŒå˜é‡æ›¿æ¢ï¼‰ */
  description: string;

  /** é€‰é¡¹ */
  choices: PresetChoice[];

  /** æœ¬äº‹ä»¶çš„å†·å´ï¼ˆè§¦å‘åNåœºæˆ˜æ–—å†…ä¸å†å‡ºç°ï¼‰ */
  cooldown: number;
  
  /** æ˜¯å¦åªèƒ½è§¦å‘ä¸€æ¬¡ */
  oneTime: boolean;
}

interface PresetChoice {
  text: string;
  risk: 'low' | 'medium' | 'high';
  
  /** æˆåŠŸæ¦‚ç‡ï¼ˆ1.0 = å¿…å®šæˆåŠŸï¼‰ */
  successRate: number;
  
  /** æˆåŠŸç»“æœ */
  successOutcome: EventOutcome;
  
  /** å¤±è´¥ç»“æœï¼ˆsuccessRate < 1.0 æ—¶éœ€è¦ï¼‰ */
  failOutcome?: EventOutcome;
  
  /** éœ€è¦æ¶ˆè€—ï¼ˆå¦‚é‡‘å¸ã€é“å…·ï¼‰ */
  requirements?: {
    gold?: number;
    itemId?: string;
    hpPercent?: number;
  };
}

interface EventOutcome {
  narrative: string;       // ç»“æœå™äº‹æ¨¡æ¿
  rewards: {
    exp?: number;          // åŸºç¡€ç»éªŒï¼ˆä¼šä¹˜ä»¥ç­‰çº§ç³»æ•°ï¼‰
    gold?: number;         // åŸºç¡€é‡‘å¸
    items?: { itemId: string; quantity: number; dropRate: number }[];
    skillUnlock?: string;  // è§£é”æŠ€èƒ½ID
    statBoost?: { stat: string; value: number; duration: number }; // ä¸´æ—¶å±æ€§æå‡
  };
  consequences: {
    hpChange?: number;     // HPå˜åŒ–ï¼ˆè´Ÿæ•°=æ‰£è¡€ï¼Œç™¾åˆ†æ¯”å¦‚-0.2=æ‰£20%æœ€å¤§HPï¼‰
    mpChange?: number;
    reputationChange?: { factionId: string; amount: number };
    unlockAreaId?: string; // è§£é”æ–°åŒºåŸŸ
    triggerQuestId?: string;
    triggerEventId?: string; // é“¾å¼è§¦å‘å¦ä¸€ä¸ªäº‹ä»¶
  };
}
```

### 4.3 é¢„åˆ¶äº‹ä»¶ç¤ºä¾‹

```typescript
const PRESET_EVENTS: PresetEvent[] = [
  // ==================== æ™®é€šäº‹ä»¶ ====================
  {
    id: 'evt_common_chest',
    name: 'è·¯è¾¹çš„å®ç®±',
    category: 'exploration',
    tier: 'common',
    conditions: {},
    description: 'ä½ åœ¨è·¯è¾¹å‘ç°äº†ä¸€ä¸ªè€æ—§çš„æœ¨ç®±ï¼Œä¸Šé¢å¸ƒæ»¡äº†é’è‹”ã€‚',
    cooldown: 5,
    oneTime: false,
    choices: [
      {
        text: 'æ‰“å¼€å®ç®±',
        risk: 'low',
        successRate: 0.85,
        successOutcome: {
          narrative: 'å®ç®±æ‰“å¼€äº†ï¼é‡Œé¢æœ‰äº›ä¸é”™çš„ä¸œè¥¿ã€‚',
          rewards: { gold: 50, exp: 20, items: [
            { itemId: 'common_material_random', quantity: 1, dropRate: 1.0 },
          ]},
          consequences: {},
        },
        failOutcome: {
          narrative: 'å®ç®±æ˜¯ä¸ªé™·é˜±ï¼ä¸€è‚¡æ¯’æ°”å–·äº†å‡ºæ¥ï¼',
          rewards: {},
          consequences: { hpChange: -0.1 },
        },
      },
      {
        text: 'è°¨æ…ç¦»å¼€',
        risk: 'low',
        successRate: 1.0,
        successOutcome: {
          narrative: 'ä½ è°¨æ…åœ°ç»•è¿‡äº†å®ç®±ï¼Œç»§ç»­å‰è¡Œã€‚',
          rewards: { exp: 5 },
          consequences: {},
        },
      },
    ],
  },

  {
    id: 'evt_common_herb',
    name: 'è·¯è¾¹è¯è‰',
    category: 'exploration',
    tier: 'common',
    conditions: { areaTypes: ['major', 'minor'] },
    description: 'ä½ æ³¨æ„åˆ°è·¯è¾¹ç”Ÿé•¿ç€ä¸€äº›çœ‹èµ·æ¥å¾ˆçè´µçš„è¯è‰ã€‚',
    cooldown: 8,
    oneTime: false,
    choices: [
      {
        text: 'é‡‡é›†è¯è‰',
        risk: 'low',
        successRate: 1.0,
        successOutcome: {
          narrative: 'ä½ å°å¿ƒç¿¼ç¿¼åœ°é‡‡é›†äº†è¯è‰ï¼Œè¿™äº›å¯ä»¥ç”¨æ¥åˆ¶ä½œå›å¤è¯å‰‚ã€‚',
          rewards: { items: [
            { itemId: 'healing_herb', quantity: 2, dropRate: 1.0 },
            { itemId: 'rare_herb', quantity: 1, dropRate: 0.2 },
          ]},
          consequences: {},
        },
      },
      {
        text: 'ä»”ç»†ç ”ç©¶åé‡‡é›†ï¼ˆæ¶ˆè€—MPï¼‰',
        risk: 'low',
        successRate: 1.0,
        successOutcome: {
          narrative: 'ä½ ç”¨é­”åŠ›æ„ŸçŸ¥äº†ä¸€ç•ªï¼Œå‘ç°äº†æ›´ç¨€æœ‰çš„å“ç§ï¼',
          rewards: { exp: 15, items: [
            { itemId: 'healing_herb', quantity: 3, dropRate: 1.0 },
            { itemId: 'rare_herb', quantity: 1, dropRate: 0.6 },
          ]},
          consequences: { mpChange: -0.05 },
        },
        requirements: { hpPercent: 0.2 },
      },
    ],
  },

  // ==================== ç¨€æœ‰äº‹ä»¶ ====================
  {
    id: 'evt_rare_wanderer',
    name: 'æµæµªçš„æ­¦è€…',
    category: 'combat',
    tier: 'rare',
    conditions: { realmMin: 'ocean' },
    description: 'ä¸€ä½è¡£è¡«è¤´è¤›çš„æ­¦è€…æ‹¦ä½äº†ä½ çš„å»è·¯ã€‚"å¹´è½»äººï¼Œè·Ÿæˆ‘è¿‡è¿‡æ‹›å¦‚ä½•ï¼Ÿ"ä»–çš„çœ¼ç¥ä¸­é—ªçƒç€è‡ªä¿¡çš„å…‰èŠ’ã€‚',
    cooldown: 20,
    oneTime: false,
    choices: [
      {
        text: 'æ¥å—æŒ‘æˆ˜',
        risk: 'medium',
        successRate: 0.6,
        successOutcome: {
          narrative: 'ç»è¿‡ä¸€ç•ªæ¿€çƒˆçš„äº¤æ‰‹ï¼Œä½ èµ¢äº†ï¼æ­¦è€…éœ²å‡ºæ»¡æ„çš„ç¬‘å®¹ï¼Œä¼ æˆäº†ä½ ä¸€æ‹›ç§˜æŠ€ã€‚',
          rewards: { exp: 100, gold: 200, statBoost: { stat: 'attack', value: 5, duration: 10 }},
          consequences: { hpChange: -0.3 },
        },
        failOutcome: {
          narrative: 'ä½ è´¥ä¸‹é˜µæ¥ã€‚æ­¦è€…æ‘‡äº†æ‘‡å¤´ï¼š"è¿˜éœ€è¦ä¿®ç‚¼å•Šã€‚"',
          rewards: { exp: 30 },
          consequences: { hpChange: -0.5 },
        },
      },
      {
        text: 'å©‰è¨€è°¢ç»',
        risk: 'low',
        successRate: 1.0,
        successOutcome: {
          narrative: 'æ­¦è€…å¹äº†å£æ°”ï¼Œè½¬èº«ç¦»å»ã€‚"æœ‰ç¼˜å†ä¼šã€‚"',
          rewards: { exp: 10 },
          consequences: {},
        },
      },
      {
        text: 'è¯·æ•™æ­¦è‰ºï¼ˆæ¶ˆè€—é‡‘å¸ï¼‰',
        risk: 'low',
        successRate: 1.0,
        successOutcome: {
          narrative: 'æ­¦è€…æ”¶ä¸‹é…¬é‡‘ï¼Œè®¤çœŸåœ°æŒ‡ç‚¹äº†ä½ å‡ æ‹›ï¼Œä½ æ„Ÿè§‰å—ç›ŠåŒªæµ…ã€‚',
          rewards: { exp: 80, statBoost: { stat: 'defense', value: 3, duration: 10 }},
          consequences: {},
        },
        requirements: { gold: 100 },
      },
    ],
  },

  {
    id: 'evt_rare_merchant',
    name: 'ç¥ç§˜å•†äºº',
    category: 'social',
    tier: 'rare',
    conditions: {},
    description: 'ä¸€ä¸ªæˆ´ç€æ–—ç¬ çš„ç¥ç§˜å•†äººçªç„¶å‡ºç°åœ¨ä½ é¢å‰ã€‚"æœ‰äº›ç‰¹åˆ«çš„ä¸œè¥¿ï¼Œè¦çœ‹çœ‹å—ï¼Ÿ"ä»–æ€å¼€äº†æ–—ç¯·ï¼Œéœ²å‡ºäº†ç³ç…æ»¡ç›®çš„å•†å“ã€‚',
    cooldown: 15,
    oneTime: false,
    choices: [
      {
        text: 'æŸ¥çœ‹å•†å“ï¼ˆå¯è´­ä¹°ç¨€æœ‰é“å…·ï¼‰',
        risk: 'low',
        successRate: 1.0,
        successOutcome: {
          narrative: 'ä½ æµè§ˆäº†å•†äººçš„è´§ç‰©ï¼Œå‘ç°äº†ä¸€äº›åœ¨æ™®é€šå•†åº—ä¹°ä¸åˆ°çš„ä¸œè¥¿ã€‚',
          rewards: {},
          consequences: { triggerQuestId: 'secret_shop_encounter' },
        },
      },
      {
        text: 'ç”¨200é‡‘å¸èµŒä¸€ä»¶éšæœºç‰©å“',
        risk: 'medium',
        successRate: 0.5,
        successOutcome: {
          narrative: 'å•†äººä»è¢‹ä¸­æå‡ºä¸€ä»¶æ•£å‘å¾®å…‰çš„ç‰©å“â€”â€”è¿æ°”ä¸é”™ï¼',
          rewards: { items: [
            { itemId: 'rare_random_equipment', quantity: 1, dropRate: 1.0 },
          ]},
          consequences: {},
        },
        failOutcome: {
          narrative: 'å•†äººé€’ç»™ä½ ä¸€ä»¶â€¦â€¦æ™®é€šçš„çŸ³å¤´ã€‚"è¿æ°”å˜›ï¼Œæ€»æœ‰å¥½æœ‰åã€‚"',
          rewards: { items: [
            { itemId: 'common_stone', quantity: 1, dropRate: 1.0 },
          ]},
          consequences: {},
        },
        requirements: { gold: 200 },
      },
      {
        text: 'ç¦»å¼€',
        risk: 'low',
        successRate: 1.0,
        successOutcome: {
          narrative: 'ä½ æ‘†æ‘†æ‰‹ç¦»å¼€äº†ã€‚å•†äººçš„èº«å½±å¾ˆå¿«æ¶ˆå¤±åœ¨é›¾ä¸­ã€‚',
          rewards: {},
          consequences: {},
        },
      },
    ],
  },

  // ==================== å²è¯—äº‹ä»¶ ====================
  {
    id: 'evt_epic_ancient_shrine',
    name: 'è¿œå¤ç¥­å›',
    category: 'mystery',
    tier: 'epic',
    conditions: { realmMin: 'land' },
    description: 'ä½ å‘ç°äº†ä¸€åº§è¢«è—¤è”“è¦†ç›–çš„è¿œå¤ç¥­å›ã€‚ç¥­å›ä¸Šçš„ç¬¦æ–‡ä»åœ¨å¾®å¾®å‘å…‰ï¼Œä¼¼ä¹è•´å«ç€å¼ºå¤§çš„åŠ›é‡ã€‚ç©ºæ°”ä¸­å¼¥æ¼«ç€å¤è€çš„é­”åŠ›æ°”æ¯ã€‚',
    cooldown: 50,
    oneTime: false,
    choices: [
      {
        text: 'çŒ®ä¸ŠçµçŸ³ç¥ˆç¥·',
        risk: 'medium',
        successRate: 0.7,
        successOutcome: {
          narrative: 'ç¥­å›è½°é¸£ï¼è¿œå¤çš„åŠ›é‡æ¶Œå…¥ä½ çš„èº«ä½“ï¼Œä½ æ„Ÿåˆ°ä¸€é˜µå‰æ‰€æœªæœ‰çš„å¼ºå¤§ï¼',
          rewards: {
            exp: 500,
            statBoost: { stat: 'all', value: 10, duration: 20 },
          },
          consequences: {},
        },
        failOutcome: {
          narrative: 'ç¥­å›ä¸Šçš„ç¬¦æ–‡é—ªçƒäº†ä¸€ä¸‹ä¾¿ç†„ç­äº†ã€‚ä¼¼ä¹ä½ çš„è¯šæ„è¿˜ä¸å¤Ÿâ€¦â€¦',
          rewards: { exp: 50 },
          consequences: {},
        },
        requirements: { gold: 500 },
      },
      {
        text: 'å°è¯•è§£è¯»ç¬¦æ–‡',
        risk: 'high',
        successRate: 0.4,
        successOutcome: {
          narrative: 'ä½ æˆåŠŸè§£è¯»äº†è¿œå¤ç¬¦æ–‡ï¼ä¸€æ®µå¤±ä¼ çš„æŠ€æ³•æ¶Œå…¥è„‘æµ·â€”â€”ä½ é¢†æ‚Ÿäº†æ–°çš„åŠ›é‡ï¼',
          rewards: {
            exp: 300,
            skillUnlock: 'ancient_power',
          },
          consequences: {},
        },
        failOutcome: {
          narrative: 'ç¬¦æ–‡çš„åŠ›é‡å¤±æ§äº†ï¼ä¸€è‚¡å†²å‡»æ³¢å°†ä½ å‡»é£ï¼',
          rewards: { exp: 30 },
          consequences: { hpChange: -0.4, mpChange: -0.3 },
        },
      },
      {
        text: 'è®°å½•ä½ç½®åç¦»å¼€',
        risk: 'low',
        successRate: 1.0,
        successOutcome: {
          narrative: 'ä½ ä»”ç»†è®°å½•äº†ç¥­å›çš„ä½ç½®ã€‚ä¹Ÿè®¸å‡†å¤‡æ›´å……åˆ†æ—¶å†æ¥æ¢ç´¢ã€‚',
          rewards: { exp: 20 },
          consequences: {},
        },
      },
    ],
  },

  // ==================== ä¼ è¯´äº‹ä»¶ ====================
  {
    id: 'evt_legendary_sea_call',
    name: 'æ·±æµ·çš„å‘¼å”¤',
    category: 'background',
    tier: 'legendary',
    conditions: {
      background: ['æµ·æ´‹ä¹‹å­'],
      areaTypes: ['major'],
      timeOfDay: ['æ·±å¤œ'],
    },
    description: 'æ·±å¤œï¼Œä½ çªç„¶ä»ç¡æ¢¦ä¸­æƒŠé†’ã€‚ä¸€ä¸ªå¤è€è€Œç†Ÿæ‚‰çš„å£°éŸ³åœ¨ä½ è„‘æµ·ä¸­å›è¡ï¼š"å­©å­â€¦â€¦æ¥å§â€¦â€¦å¤§æµ·åœ¨å‘¼å”¤ä½ â€¦â€¦"ä½ æ„Ÿåˆ°æµ·æ´‹çš„åŠ›é‡åœ¨è¡€è„‰ä¸­æ¶ŒåŠ¨ã€‚',
    cooldown: 100,
    oneTime: true,
    choices: [
      {
        text: 'å¾ªç€å£°éŸ³èµ°å‘å¤§æµ·',
        risk: 'high',
        successRate: 0.8,
        successOutcome: {
          narrative: 'ä½ èµ°å…¥æœˆå…‰ä¸‹çš„æµ·æ°´ä¸­ï¼Œä¸€å¤´å·¨å¤§çš„æµ·å…½ä»æ·±å¤„æµ®ç°ã€‚å®ƒæ¸©æŸ”åœ°æ³¨è§†ç€ä½ ï¼Œä»¿ä½›çœ‹åˆ°äº†ä¹…åˆ«é‡é€¢çš„äº²äººã€‚æµ·å…½ä½ä¸‹å¤´æ¥ï¼Œè¡¨ç¤ºæ„¿æ„ä¸ä½ ç¼”ç»“å¥‘çº¦ã€‚',
          rewards: {
            exp: 1000,
            items: [
              { itemId: 'sea_beast_contract', quantity: 1, dropRate: 1.0 },
            ],
          },
          consequences: {
            triggerQuestId: 'sea_beast_bond',
          },
        },
        failOutcome: {
          narrative: 'ä½ èµ°å…¥æµ·ä¸­ï¼Œä½†ä¸€è‚¡æš—æµçªç„¶å°†ä½ å·å…¥æ·±å¤„ï¼ä½ æ‹¼å°½å…¨åŠ›æ‰æŒ£è„±ï¼Œæµ‘èº«æ¹¿é€ï¼Œç²¾ç–²åŠ›ç«­åœ°çˆ¬ä¸Šå²¸ã€‚ä½†ä½ éšçº¦æ„Ÿè§‰åˆ°â€¦â€¦é‚£ä¸ªå£°éŸ³è¿˜åœ¨ç­‰ç€ä½ ã€‚',
          rewards: { exp: 200 },
          consequences: { hpChange: -0.6, mpChange: -0.5 },
        },
      },
      {
        text: 'å†¥æƒ³å›åº”è¿™ä¸ªå£°éŸ³',
        risk: 'medium',
        successRate: 1.0,
        successOutcome: {
          narrative: 'ä½ ç›˜è†è€Œåï¼Œç”¨å†…å¿ƒå›åº”é‚£ä¸ªå£°éŸ³ã€‚æµ·æ´‹çš„åŠ›é‡ç¼“ç¼“æ¸—å…¥ä½ çš„èº«ä½“ï¼Œä½ çš„å¢ƒç•Œä¿®ä¸ºè·å¾—äº†æ˜¾è‘—æå‡ã€‚',
          rewards: {
            exp: 800,
            statBoost: { stat: 'mp', value: 50, duration: 50 },
          },
          consequences: {},
        },
      },
      {
        text: 'æŠµæŠ—å‘¼å”¤ï¼Œç»§ç»­ç¡è§‰',
        risk: 'low',
        successRate: 1.0,
        successOutcome: {
          narrative: 'ä½ å¼ºè¡Œå‹åˆ¶ä½äº†é‚£ä¸ªå£°éŸ³ï¼Œé‡æ–°æ²‰å…¥æ¢¦ä¹¡ã€‚ä½†æ¢¦ä¸­ï¼Œä½ çœ‹åˆ°äº†å¹¿é˜”æ— å çš„æ·±æµ·å’Œä¸€åŒæ¸©æŸ”çš„çœ¼ç›â€¦â€¦',
          rewards: { exp: 100 },
          consequences: {},
        },
      },
    ],
  },
];
```

---

## äº”ã€äº‹ä»¶é€‰æ‹©ä¸æŠ½å–ç®—æ³•

### 5.1 äº‹ä»¶ç­›é€‰

```typescript
/**
 * ä»äº‹ä»¶æ± ä¸­ç­›é€‰å½“å‰å¯ç”¨çš„äº‹ä»¶
 */
function filterAvailableEvents(
  tier: string,
  ctx: TriggerContext,
  playerHistory: PlayerAdventureHistory
): PresetEvent[] {
  return PRESET_EVENTS.filter(event => {
    // ç­‰çº§åŒ¹é…
    if (event.tier !== tier) return false;

    // ä¸€æ¬¡æ€§äº‹ä»¶å·²å®Œæˆ
    if (event.oneTime && playerHistory.completedEvents.has(event.id)) return false;

    // å†·å´ä¸­
    if (playerHistory.eventCooldowns.get(event.id) ?? 0 > 0) return false;

    // æ¡ä»¶æ£€æŸ¥
    const c = event.conditions;
    if (c.realmMin && realmIndex(ctx.player.realm) < realmIndex(c.realmMin)) return false;
    if (c.realmMax && realmIndex(ctx.player.realm) > realmIndex(c.realmMax)) return false;
    if (c.areaTypes && !c.areaTypes.includes(getAreaType(ctx.player.currentAreaId))) return false;
    if (c.weather && !c.weather.includes(ctx.environment.weather)) return false;
    if (c.timeOfDay && !c.timeOfDay.includes(ctx.environment.timeOfDay)) return false;
    if (c.season && !c.season.includes(ctx.environment.season)) return false;
    if (c.background && !c.background.includes(ctx.player.background)) return false;

    return true;
  });
}

/**
 * ä»å¯ç”¨äº‹ä»¶ä¸­æŠ½å–ä¸€ä¸ª
 * å¦‚æœæœ‰å¤šä¸ªå¯ç”¨ï¼ŒæŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§ï¼š
 * 1. èƒŒæ™¯ä¸“å±äº‹ä»¶ï¼ˆé«˜ä¼˜å…ˆï¼‰
 * 2. åŒºåŸŸä¸“å±äº‹ä»¶
 * 3. é€šç”¨äº‹ä»¶
 * åœ¨åŒä¼˜å…ˆçº§å†…éšæœºé€‰æ‹©
 */
function selectEvent(ctx: TriggerContext, tier: string): AdventureEvent {
  const available = filterAvailableEvents(tier, ctx, getPlayerHistory(ctx.player));

  if (available.length === 0) {
    // æ²¡æœ‰åŒ¹é…çš„é¢„åˆ¶äº‹ä»¶ â†’ è¯·æ±‚AIç”Ÿæˆ
    return requestAiGeneratedEvent(ctx, tier);
  }

  // ä¼˜å…ˆçº§æ’åº
  const prioritized = available.sort((a, b) => {
    const aPriority = getEventPriority(a, ctx);
    const bPriority = getEventPriority(b, ctx);
    return bPriority - aPriority;
  });

  // ä»æœ€é«˜ä¼˜å…ˆçº§ç»„ä¸­éšæœºé€‰æ‹©
  const topPriority = getEventPriority(prioritized[0], ctx);
  const topGroup = prioritized.filter(e => getEventPriority(e, ctx) === topPriority);
  
  return topGroup[Math.floor(Math.random() * topGroup.length)];
}

function getEventPriority(event: PresetEvent, ctx: TriggerContext): number {
  let priority = 0;
  if (event.category === 'background') priority += 10;
  if (event.conditions.areaTypes?.length) priority += 5;
  if (event.conditions.weather?.length) priority += 3;
  if (event.conditions.timeOfDay?.length) priority += 3;
  if (event.oneTime) priority += 2; // ä¸€æ¬¡æ€§äº‹ä»¶ä¼˜å…ˆå±•ç¤º
  return priority;
}
```

### 5.2 AI ç”Ÿæˆäº‹ä»¶ï¼ˆå…œåº•/è¡¥å……ï¼‰

å½“é¢„åˆ¶äº‹ä»¶æ± ä¸­æ²¡æœ‰åŒ¹é…äº‹ä»¶æ—¶ï¼Œå¯è¯·æ±‚AIç”Ÿæˆï¼š

```typescript
/**
 * AIç”Ÿæˆäº‹ä»¶
 * ä»…åœ¨é¢„åˆ¶äº‹ä»¶æ± æ— åŒ¹é…æ—¶è°ƒç”¨
 * AIåªè´Ÿè´£ç”Ÿæˆå™äº‹æ–‡æœ¬ï¼Œæ•°å€¼ç”±æœ¬åœ°è®¡ç®—
 */
async function requestAiGeneratedEvent(
  ctx: TriggerContext,
  tier: string
): Promise<AdventureEvent> {
  // å…ˆè®¡ç®—æ•°å€¼æ¡†æ¶
  const rewardScale = TIER_REWARD_SCALES[tier];
  const baseRewards = calculateBaseRewards(ctx.player.level, rewardScale);

  // è¯·æ±‚AIå¡«å……å™äº‹å†…å®¹
  const aiResult = await chaosSagaAI.generate({
    type: 'adventure_event',
    input: {
      player: ctx.player,
      environment: ctx.environment,
      eventTier: tier,
      previousEvents: getRecentEventNames(ctx),
      // ä¼ å…¥æ•°å€¼æ¡†æ¶ï¼Œè®©AIåœ¨æ­¤åŸºç¡€ä¸Šåˆ›ä½œå™äº‹
      rewardFramework: baseRewards,
    },
  });

  // åˆå¹¶AIå™äº‹ + æœ¬åœ°æ•°å€¼
  return mergeAiEventWithValues(aiResult.data, baseRewards);
}
```

---

## å…­ã€å¥–åŠ±ç»“ç®—ç³»ç»Ÿ

### 6.1 å¥–åŠ±ç¼©æ”¾å…¬å¼

```typescript
// lib/game/adventure-rewards.ts

/** å„ç­‰çº§çš„å¥–åŠ±åŸºç¡€å€ç‡ */
const TIER_REWARD_SCALES: Record<string, number> = {
  common: 1.0,
  rare: 2.0,
  epic: 4.0,
  legendary: 8.0,
};

/**
 * è®¡ç®—å¥‡é‡å¥–åŠ±çš„å®é™…æ•°å€¼
 * åŸºç¡€å€¼ä¼šæ ¹æ®ç©å®¶ç­‰çº§ç¼©æ”¾
 */
function calculateActualRewards(
  baseRewards: EventOutcome['rewards'],
  playerLevel: number,
  tier: string
): ResolvedRewards {
  const scale = TIER_REWARD_SCALES[tier] ?? 1.0;
  const levelScale = 1 + (playerLevel - 1) * 0.1; // æ¯çº§+10%

  return {
    exp: Math.floor((baseRewards.exp ?? 0) * levelScale * scale),
    gold: Math.floor((baseRewards.gold ?? 0) * levelScale * scale),
    items: (baseRewards.items ?? [])
      .filter(item => Math.random() < item.dropRate)
      .map(item => ({
        itemId: item.itemId,
        quantity: item.quantity,
      })),
    skillUnlock: baseRewards.skillUnlock,
    statBoost: baseRewards.statBoost,
  };
}

/**
 * æ‰§è¡Œé€‰é¡¹ç»“æœ
 */
function resolveChoice(
  event: PresetEvent,
  choiceIndex: number,
  player: PlayerState
): EventResolution {
  const choice = event.choices[choiceIndex];

  // æ£€æŸ¥éœ€æ±‚
  if (choice.requirements) {
    if (choice.requirements.gold && player.gold < choice.requirements.gold) {
      return { success: false, message: 'é‡‘å¸ä¸è¶³' };
    }
    if (choice.requirements.hpPercent && 
        (player.currentHp / player.maxHp) < choice.requirements.hpPercent) {
      return { success: false, message: 'HPä¸è¶³' };
    }
  }

  // æ‰£é™¤æ¶ˆè€—
  if (choice.requirements?.gold) {
    player.gold -= choice.requirements.gold;
  }

  // åˆ¤å®šæˆåŠŸ/å¤±è´¥
  const isSuccess = Math.random() < choice.successRate;
  const outcome = isSuccess ? choice.successOutcome : choice.failOutcome!;

  // è®¡ç®—å¥–åŠ±
  const rewards = calculateActualRewards(
    outcome.rewards,
    player.level,
    event.tier
  );

  // åº”ç”¨åæœ
  applyConsequences(player, outcome.consequences);

  return {
    success: isSuccess,
    narrative: outcome.narrative,
    rewards,
    consequences: outcome.consequences,
  };
}
```

---

## ä¸ƒã€é“¾å¼äº‹ä»¶ä¸äº‹ä»¶è®°å¿†

### 7.1 é“¾å¼äº‹ä»¶è§¦å‘

```typescript
/**
 * æŸäº›äº‹ä»¶çš„ç»“æœå¯ä»¥è§¦å‘åç»­äº‹ä»¶
 * å½¢æˆäº‹ä»¶é“¾ï¼Œåˆ›é€ è¿ç»­çš„å™äº‹ä½“éªŒ
 */
interface EventChain {
  chainId: string;
  events: string[];        // æœ‰åºçš„äº‹ä»¶IDåˆ—è¡¨
  currentStep: number;
  triggerCondition: 'immediate' | 'next_battle' | 'next_explore' | 'area_enter';
}

// ç¤ºä¾‹ï¼šæµ·æ´‹ä¹‹å­çš„ä¸“å±äº‹ä»¶é“¾
const SEA_CHILD_CHAIN: EventChain = {
  chainId: 'sea_child_awakening',
  events: [
    'evt_legendary_sea_call',       // 1. æ·±æµ·çš„å‘¼å”¤
    'evt_chain_sea_beast_appear',   // 2. æµ·å…½æ˜¾ç°
    'evt_chain_sea_bond',           // 3. å¥‘çº¦ç¼”ç»“
    'evt_chain_sea_power',          // 4. æµ·æ´‹ä¹‹åŠ›è§‰é†’
  ],
  currentStep: 0,
  triggerCondition: 'next_battle',
};
```

### 7.2 äº‹ä»¶å†å²è®°å½•

```typescript
interface PlayerAdventureHistory {
  /** å·²å®Œæˆçš„ä¸€æ¬¡æ€§äº‹ä»¶ */
  completedEvents: Set<string>;
  
  /** äº‹ä»¶å†·å´è®¡æ•°å™¨ (äº‹ä»¶ID â†’ å‰©ä½™å†·å´åœºæ¬¡) */
  eventCooldowns: Map<string, number>;
  
  /** æ´»è·ƒçš„äº‹ä»¶é“¾ */
  activeChains: EventChain[];
  
  /** ç»Ÿè®¡æ•°æ® */
  stats: {
    totalEvents: number;
    eventsByTier: Record<string, number>;
    eventsByCategory: Record<string, number>;
  };
  
  /** è·ä¸Šæ¬¡å¥‡é‡çš„æˆ˜æ–—åœºæ¬¡ (ç”¨äºä¿åº•) */
  battlesSinceLastEvent: number;
  
  /** ä»Šæ—¥è§¦å‘æ¬¡æ•° */
  todayEventCount: number;
}

/**
 * æ¯åœºæˆ˜æ–—åæ›´æ–°å†·å´è®¡æ•°å™¨
 */
function tickCooldowns(history: PlayerAdventureHistory): void {
  for (const [eventId, cooldown] of history.eventCooldowns) {
    if (cooldown > 0) {
      history.eventCooldowns.set(eventId, cooldown - 1);
    } else {
      history.eventCooldowns.delete(eventId);
    }
  }
  history.battlesSinceLastEvent++;
}
```

---

## å…«ã€æ•°æ®åº“æ‰©å±•

### 8.1 æ–°å¢ï¼šç©å®¶å¥‡é‡è®°å½•è¡¨ (PlayerAdventure)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | String | ä¸»é”® |
| playerId | String | ç©å®¶ID (FK) |
| eventId | String | äº‹ä»¶ID |
| tier | Enum | common/rare/epic/legendary |
| category | String | äº‹ä»¶åˆ†ç±» |
| choiceIndex | Int | ç©å®¶é€‰æ‹©çš„é€‰é¡¹ç´¢å¼• |
| isSuccess | Boolean | é€‰æ‹©ç»“æœæ˜¯å¦æˆåŠŸ |
| rewards | Json | å®é™…è·å¾—çš„å¥–åŠ± |
| narrative | String | äº‹ä»¶å™äº‹æ–‡æœ¬ |
| createdAt | DateTime | è§¦å‘æ—¶é—´ |

### 8.2 Prisma Schema è¡¥å……

```prisma
model PlayerAdventure {
  id          String   @id @default(cuid())
  playerId    String
  eventId     String
  tier        String
  category    String
  choiceIndex Int
  isSuccess   Boolean
  rewards     Json
  narrative   String   @db.Text
  createdAt   DateTime @default(now())

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId, createdAt])
}
```

---

> ğŸ“ æœ¬æ–‡æ¡£å®šä¹‰äº† ChaosSaga çš„å®Œæ•´å¥‡é‡äº‹ä»¶ç³»ç»Ÿã€‚è§¦å‘åˆ¤å®šã€ç­‰çº§æŠ½å–ã€å¥–åŠ±è®¡ç®—å‡ç”±ä¼ ç»Ÿç®—æ³•é©±åŠ¨ï¼Œä»…åœ¨é¢„åˆ¶äº‹ä»¶æ± æ— åŒ¹é…æ—¶æ‰è°ƒç”¨AIç”Ÿæˆå™äº‹å†…å®¹ã€‚äº‹ä»¶æ± æ”¯æŒä¸°å¯Œçš„æ¡ä»¶ç­›é€‰ã€é“¾å¼è§¦å‘å’Œä¿åº•æœºåˆ¶ã€‚
